<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ì‹œê°ì  ë¶„ì„</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 80%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8E12D5, #6a0dad);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .control-panel h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .control-group select, .control-group input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            min-width: 200px;
            transition: border-color 0.3s ease;
        }

        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #8E12D5;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #8E12D5, #6a0dad);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(142, 18, 213, 0.4);
        }

        .visualization-section {
            margin-bottom: 40px;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 0; /* flex ì•„ì´í…œì´ ì¶•ì†Œë˜ì§€ ì•Šë„ë¡ */
        }

        .section-title {
            color: #000000;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #8E12D5, #6a0dad);
            border-radius: 2px;
        }

        .chart-container {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* .radar-chart-container {
            height: 500px;
            position: relative;
        }

        .heatmap-container {
            overflow-x: auto;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .heatmap-table th, .heatmap-table td {
            border: 1px solid #e9ecef;
            padding: 12px;
            text-align: center;
            font-size: 0.9rem;
        }

        .heatmap-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .heatmap-table td {
            position: relative;
        }

        .heatmap-cell {
            padding: 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
        } */

        /* ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .sorting-list {
            margin-top: 20px;
        }

        .sorting-list h4 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }

        .sorting-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sorting-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .sorting-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .sorting-item.top-rank {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-color: #ffc107;
        }

        .sorting-item .rank {
            background: #8E12D5;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .sorting-item .personality {
            flex: 1;
            font-weight: 600;
            color: #495057;
        }

        .sorting-item .value {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            color: #8E12D5;
            min-width: 60px;
            text-align: center;
        }

        /* ì •ë³´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: #1976d2;
            font-size: 18px;
        }

        .info-box strong {
            color: #0d47a1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }

        /* ë¡œë”© í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .loading-indicator {
            display: inline-block;
            margin-left: 10px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #8E12D5, #6a0dad);
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(142, 18, 213, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* ë¡œë”© ì¤‘ì¼ ë•Œ ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .chart-container.loading {
            position: relative;
            min-height: 200px;
        }

        .chart-container.loading::after {
            content: 'â³ ë¶„ì„ ì¤‘...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            color: #8E12D5;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .sorting-list {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .sorting-list h4 {
            margin-top: 0;
            color: #495057;
            text-align: center;
            margin-bottom: 20px;
        }

        .sorting-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sorting-item {
            display: flex;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .sorting-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .sorting-item.top-rank {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 2px solid #ffc107;
        }

        .sorting-item .rank {
            background-color: #007bff;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .sorting-item.top-rank .rank {
            background-color: #ff6b35;
        }

        .sorting-item .personality {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        /* í´ë¦­ ê°€ëŠ¥í•œ í˜ë¥´ì†Œë‚˜ ìŠ¤íƒ€ì¼ */
        .clickable-persona {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .clickable-persona:hover {
            background-color: #e3f2fd;
            color: #1976d2;
            transform: scale(1.02);
        }

        .clickable-persona:active {
            transform: scale(0.98);
        }

        .sorting-item .value {
            background-color: #e9ecef;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: #495057;
            min-width: 60px;
            text-align: center;
        }

        /* ë”ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .show-more-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .show-more-btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .show-more-btn:active {
            transform: translateY(0);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #bee5eb;
            font-size: 18px;
        }

        /* íƒœê·¸ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .tag-highlight {
            transition: all 0.3s ease;
            cursor: help;
        }

        .tag-highlight:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* íƒœê·¸ë³„ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ */
        .tag-emotion {
            background-color: #e3f2fd !important;
            border-color: #2196f3 !important;
        }

        .tag-behavior {
            background-color: #e8f5e8 !important;
            border-color: #4caf50 !important;
        }

        .tag-relationship {
            background-color: #fff3e0 !important;
            border-color: #ff9800 !important;
        }

        .tag-expression {
            background-color: #fce4ec !important;
            border-color: #e91e63 !important;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group select, .control-group input {
                min-width: auto;
            }
            
            .analyze-btn {
                margin-left: 0;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</button>
            <h1>í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ì‹œê°í™” ë¶„ì„</h1>
            <p>ì˜ë¯¸ ì¶•ì— ë”°ë¥¸ í™˜ìë³„ í˜ë¥´ì†Œë‚˜ ì°¨ì´ ë¶„ì„</p>
        </div>

        <div class="content">
            <!-- ì œì–´ íŒ¨ë„ -->
            <div class="control-panel">
                <h3>ë¶„ì„ ì„¤ì •</h3>
                <div class="control-row">
                    <div class="control-group">
                        <label for="experimentSelect">ì‹¤í—˜ ì„ íƒ</label>
                        <select id="experimentSelect">
                            <option value="">ì €ì¥ëœ ì‹¤í—˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="questionSelect">ì§ˆë¬¸ ì„ íƒ</label>
                        <select id="questionSelect">
                            <option value="">ì§ˆë¬¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="dimensionSelect">ì˜ë¯¸ ì¶• ì„ íƒ</label>
                        <select id="dimensionSelect">
                            <option value="">ì˜ë¯¸ ì¶•ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <!-- <div class="control-group">
                        <label for="heatmapTypeSelect">íˆíŠ¸ë§µ íƒ€ì…</label>
                        <select id="heatmapTypeSelect">
                            <option value="plotly">Plotly (ì¸í„°ë™í‹°ë¸Œ)</option>
                            <option value="seaborn">Seaborn (ì •ì )</option>
                        </select>
                    </div> -->
                    <button class="analyze-btn" onclick="startCompleteAnalysis()">í†µí•© ë¶„ì„ ì‹œì‘</button>

                </div>
            </div>

            <!-- ë ˆì´ë” ì°¨íŠ¸ ì„¹ì…˜ -->
            <!-- <div class="visualization-section">
                <h3 class="section-title">ë ˆì´ë” ì°¨íŠ¸ (Radar Chart)</h3>
                <div class="chart-container">
                    <div class="radar-chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div> -->

            <!-- íˆíŠ¸ë§µ ì„¹ì…˜ -->
            <!-- <div class="visualization-section">
                <h3 class="section-title">íˆíŠ¸ë§µ (Heatmap)</h3>
                <div class="chart-container">
                    <div class="heatmap-container">
                        <div id="heatmapContent">
                            <div class="info-box">
                                <strong>íˆíŠ¸ë§µ ì‚¬ìš©ë²•:</strong> ì§ˆë¬¸ê³¼ ì˜ë¯¸ ì¶•ì„ ì„ íƒí•œ í›„ ë¶„ì„ì„ ì‹œì‘í•˜ë©´, 
                                í˜ë¥´ì†Œë‚˜ë³„ ì‘ë‹µì„ ìƒ‰ìƒ ê°•ë„ë¡œ ì‹œê°í™”í•˜ì—¬ ê²½í–¥ì„±ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->

            <!-- ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ì™€ Side-by-Side ì‘ë‹µ ë¹„êµë¥¼ ë‚˜ë€íˆ í‘œì‹œ -->
            <div style="display: flex; gap: 30px; margin-top: 30px;">
                <!-- ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ì„¹ì…˜ -->
                <div class="visualization-section" style="flex: 1;">
                    <h3 class="section-title">
                        ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸
                        <span id="sortingChartLoading" class="loading-indicator" style="display: none;">â³ 1ë‹¨ê³„: ì‹œê°í™” ìƒì„± ì¤‘...</span>
                    </h3>
                    <!-- <div class="chart-container">
                        <div id="sortingContent">
                            <div class="info-box">
                                <strong>ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ì‚¬ìš©ë²•:</strong> ì˜ë¯¸ ì¶•ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¶•ì— ë”°ë¼ 
                                í˜ë¥´ì†Œë‚˜ë“¤ì„ ì •ë ¬í•˜ì—¬ ë§‰ëŒ€ ì°¨íŠ¸ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. "ìê¸°ì£¼ë„ì„±ì´ ë†’ì€ ìˆœ", "ê°ì • ê°•ë„ê°€ ë‚®ì€ ìˆœ" ë“±ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </div>
                        </div>
                    </div> -->
                </div>

                                <!-- Side-by-Side Diff ë¹„êµ ì„¹ì…˜ -->
                <div id="diffSection" class="visualization-section" style="display: block; flex: 1;">
                    <h3 class="section-title">
                        Side-by-Side ì‘ë‹µ ë¹„êµ
                    </h3>
            
            <!-- í˜ë¥´ì†Œë‚˜ ì„ íƒ -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center;">
                        <label for="personaA" style="font-size: 18px; font-weight: bold; margin-right: 10px;">í˜ë¥´ì†Œë‚˜ A:</label>
                        <select id="personaA" style="padding: 10px; font-size: 16px; min-width: 200px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; align-items: center;">
                        <label for="personaB" style="font-size: 18px; font-weight: bold; margin-right: 10px;">í˜ë¥´ì†Œë‚˜ B:</label>
                        <select id="personaB" style="padding: 10px; font-size: 16px; min-width: 200px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    
                    <button id="diffAnalyzeBtn" onclick="generateDiff()" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ë¹„êµ ë¶„ì„
                    </button>
                    <span id="diffLoading" class="loading-indicator" style="display: none;">ë¹„êµ ë¶„ì„ ì¤‘...</span>
                </div>
            </div>
            
            <!-- ë¹„êµ ê²°ê³¼ -->
            <div id="diffContent" style="display: none;">
                <!-- ì§ˆë¬¸ í‘œì‹œ -->
                <div id="diffQuestion" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;"></div>
                
                <!-- ì‘ë‹µ ë¹„êµ -->
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div style="flex: 1; background-color: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h4 id="personaAName" style="margin-top: 0; color: #1976d2;"></h4>
                        <div id="responseA" style="background-color: white; padding: 10px; border-radius: 4px; min-height: 100px;"></div>
                    </div>
                    
                    <div style="flex: 1; background-color: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <h4 id="personaBName" style="margin-top: 0; color: #7b1fa2;"></h4>
                        <div id="responseB" style="background-color: white; padding: 10px; border-radius: 4px; min-height: 100px;"></div>
                    </div>
                </div>
                
                <!-- ìœ ì‚¬ë„ ì ìˆ˜ -->
                <div id="similarityScore" style="background-color: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <h4 style="margin-top: 0; color: #f57c00;">ğŸ“Š ë¬¸ì¥ ìœ ì‚¬ë„</h4>
                    <div id="similarityValue" style="font-size: 24px; font-weight: bold;"></div>
                </div>
                
                <!-- ì˜ë¯¸ ì¶•ë³„ ì°¨ì´ -->
                <div id="dimensionDiffs" style="background-color: #f1f8e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0; color: #388e3c;">ğŸ“ˆ ì˜ë¯¸ ì¶•ë³„ ì°¨ì´ ë¶„ì„</h4>
                    <div id="dimensionDiffsContent"></div>
                </div>
                
                <!-- ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸ -->
                <div id="diffHighlights" style="background-color: #fff8e1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                          <h4 style="margin-top: 0; color: #f9a825;">ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸</h4>
                    <div id="diffHighlightsContent" style="font-size: 15px;"></div>
                </div>
                
                <!-- ìš”ì•½ -->
                <div id="diffSummary" style="background-color: #e8f5e8; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #2e7d32; font-size: 25px;"> ë¹„êµ ìš”ì•½</h4>
                    <div id="diffSummaryContent" style="font-size: 15px;"></div>
                </div>
                </div>
            </div>
        </div>
        
        <!-- ì¶•ë³„ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ (ê¸°ì¤€ë³„ ì†ŒíŒ…) ì„¹ì…˜ -->
        <div id="sortingListSection" class="visualization-section" style="display: none; margin-top: 30px;">
            <h3 class="section-title">
                ì¶•ë³„ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ (ê¸°ì¤€ë³„ ì†ŒíŒ…)
                <span id="sortingListLoading" class="loading-indicator" style="display: none;">â³ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ìƒì„± ì¤‘...</span>
            </h3>
            <div id="sortingListContent"></div>
        </div>

                <!-- êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼ ì„¹ì…˜ -->
        <div id="structuredAnalysisSection" class="visualization-section" style="margin-top: 30px;">
            <h3 class="section-title">
                êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼
                <span id="structuredAnalysisLoading" class="loading-indicator" style="display: none;">â³ 2ë‹¨ê³„: êµ¬ì¡°í™”ëœ ë¶„ì„ ìƒì„± ì¤‘...</span>
            </h3>
                
                <!-- ë¶„ì„ ì˜µì…˜ -->
                <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-top: 0; color: #495057;">ğŸ”§ ë¶„ì„ ì˜µì…˜</h4>
                    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="includeEmbeddings" style="margin: 0;">
                            ì„ë² ë”© í¬í•¨
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="includeSimilarities" checked style="margin: 0;">
                            ìœ ì‚¬ë„ ê³„ì‚°
                        </label>
                        <select id="analysisDepth" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="basic">ê¸°ë³¸ ë¶„ì„</option>
                            <option value="standard" selected>í‘œì¤€ ë¶„ì„</option>
                            <option value="detailed">ìƒì„¸ ë¶„ì„</option>
                        </select>
                    </div>
                </div>
                
                <!-- ë¶„ì„ ê²°ê³¼ -->
                <div id="structuredAnalysisContent" style="display: none;">
                    <!-- ì§ˆë¬¸ ì •ë³´ -->
                    <div id="questionInfo" style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    </div>
                    
                    <!-- í˜ë¥´ì†Œë‚˜ë³„ ì‘ë‹µ ë¶„ì„ -->
                    <div id="personaResponses" style="background-color: #f1f8e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #388e3c; font-size: 20px;">ğŸ‘¥ í˜ë¥´ì†Œë‚˜ë³„ ì‘ë‹µ ë¶„ì„</h4>
                        <div id="personaResponsesContent"></div>
                    </div>
                    
                    <!-- ìœ ì‚¬ë„ ë§¤íŠ¸ë¦­ìŠ¤ -->
                    <div id="similarityMatrix" style="background-color: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #f57c00;">ğŸ”— ìœ ì‚¬ë„ ë§¤íŠ¸ë¦­ìŠ¤</h4>
                        <div id="similarityMatrixContent"></div>
                    </div>
                    
                    <!-- ì „ì²´ í†µê³„ -->
                    <div id="overallStatistics" style="background-color: #f8e8f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #9c27b0;">ğŸ“ˆ ì „ì²´ í†µê³„</h4>
                        <div id="overallStatisticsContent"></div>
                    </div>
                    
                    <!-- ëª¨ë¸ ì •ë³´ -->
                    <div id="modelInfo" style="background-color: #e8f5e8; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-top: 0; color: #2e7d32;">ğŸ¤– ëª¨ë¸ ì •ë³´</h4>
                        <div id="modelInfoContent"></div>
                    </div>
                    
                    <!-- JSON ë‹¤ìš´ë¡œë“œ -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadStructuredAnalysis()" style="padding: 12px 24px; background-color: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                            ğŸ’¾ JSON ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <script>
        let currentExperiment = null;
        let currentQuestion = null;
        let currentDimension = null;
        let currentRadarChart = null;
        let questions = []; // ì „ì—­ questions ë³€ìˆ˜ ì¶”ê°€

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
            console.log('ğŸ”§ ì´ˆê¸°í™” ì‹œì‘...');
            
            loadExperimentList();
            loadDimensionOptions();
            setupEventListeners();
            
            console.log('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            console.log('ğŸ”§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
            
            const experimentSelect = document.getElementById('experimentSelect');
            const questionSelect = document.getElementById('questionSelect');
            const dimensionSelect = document.getElementById('dimensionSelect');
            
            console.log('experimentSelect ì°¾ìŒ:', experimentSelect);
            console.log('questionSelect ì°¾ìŒ:', questionSelect);
            console.log('dimensionSelect ì°¾ìŒ:', dimensionSelect);
            
            if (experimentSelect) {
                experimentSelect.addEventListener('change', onExperimentChange);
                console.log('âœ… experimentSelect ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¨');
            }
            
            if (questionSelect) {
                questionSelect.addEventListener('change', onQuestionChange);
                console.log('âœ… questionSelect ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¨');
            }
            
            if (dimensionSelect) {
                dimensionSelect.addEventListener('change', onDimensionChange);
                console.log('âœ… dimensionSelect ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ë¨');
            }
        }

        // ì˜ë¯¸ ì¶• ì˜µì…˜ ë¡œë“œ
        async function loadDimensionOptions() {
            try {
                const response = await fetch('/responses/personality.json');
                if (response.ok) {
                    const personalityData = await response.json();
                    console.log('ì„±ê²© ë°ì´í„° ë¡œë“œ ì„±ê³µ:', personalityData);
                    
                    const dimensionSelect = document.getElementById('dimensionSelect');
                    dimensionSelect.innerHTML = '<option value="">ì˜ë¯¸ ì¶•ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    // ê¸°ì§ˆ(Temperament) ê¸°ë°˜ ì˜ë¯¸ ì¶•
                    const temperament = personalityData.filter(p => p.type === 'temperament');
                    if (temperament.length > 0) {
                        const temp = temperament[0];
                        Object.keys(temp.detail).forEach(key => {
                            const opt = document.createElement('option');
                            opt.value = `temperament_${key}`;
                            opt.textContent = `ê¸°ì§ˆ: ${key}`;
                            dimensionSelect.appendChild(opt);
                        });
                    }
                    
                    // ì„±ê²©(Character) ê¸°ë°˜ ì˜ë¯¸ ì¶•
                    const character = personalityData.filter(p => p.type === 'character');
                    if (character.length > 0) {
                        const char = character[0];
                        Object.keys(char.detail).forEach(key => {
                            const opt = document.createElement('option');
                            opt.value = `character_${key}`;
                            opt.textContent = `ì„±ê²©: ${key}`;
                            dimensionSelect.appendChild(opt);
                        });
                    }
                    
                    // ì¶”ê°€ ì˜ë¯¸ ì¶•
                    const additionalDimensions = [
                        { value: 'emotional_intensity', text: 'ê°ì • ê°•ë„' },
                        { value: 'valence', text: 'ì •ì„œ ë°©í–¥' },
                        { value: 'expression_type', text: 'í‘œí˜„ ìŠ¤íƒ€ì¼' },
                        { value: 'agency', text: 'ìê¸° ì£¼ë„ì„±' },
                        { value: 'extroversion', text: 'ì™¸í–¥ì„±' },
                        { value: 'solution_offered', text: 'í•´ê²° ì „ëµ ì œì‹œ' },
                        { value: 'response_length', text: 'ì‘ë‹µ ê¸¸ì´' },
                        { value: 'complexity', text: 'ì‘ë‹µ ë³µì¡ë„' }
                    ];
                    
                    additionalDimensions.forEach(dim => {
                        const opt = document.createElement('option');
                        opt.value = dim.value;
                        opt.textContent = dim.text;
                        dimensionSelect.appendChild(opt);
                    });
                    
                } else {
                    console.error('ì„±ê²© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', response.status);
                }
            } catch (error) {
                console.error('ì„±ê²© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì‹¤í—˜ ëª©ë¡ ë¡œë“œ
        async function loadExperimentList() {
            console.log('loadExperimentList í•¨ìˆ˜ ì‹œì‘');
            
            // DOM ìš”ì†Œ í™•ì¸
            const select = document.getElementById('experimentSelect');
            console.log('experimentSelect ìš”ì†Œ:', select);
            
            if (!select) {
                console.error('âŒ experimentSelect ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ! HTMLì„ í™•ì¸í•˜ì„¸ìš”.');
                return;
            }
            
            try {
                console.log('ğŸ“¡ /list_experiments API í˜¸ì¶œ ì¤‘...');
                const res = await fetch('/list_experiments');
                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', res.status, res.ok);
                console.log('ğŸ“¡ API ì‘ë‹µ í—¤ë”:', Object.fromEntries(res.headers.entries()));
                
                if (res.ok) {
                    const contentType = res.headers.get('content-type');
                    console.log('ğŸ“¡ Content-Type:', contentType);
                    
                    if (contentType && contentType.includes('application/json')) {
                        const list = await res.json();
                        console.log('ğŸ“‹ ë°›ì€ ì‹¤í—˜ ëª©ë¡:', list);
                        console.log('ğŸ“‹ ë¦¬ìŠ¤íŠ¸ íƒ€ì…:', typeof list, 'ê¸¸ì´:', Array.isArray(list) ? list.length : 'ë°°ì—´ ì•„ë‹˜');
                        
                        if (Array.isArray(list) && list.length > 0) {
                            select.innerHTML = '<option value="">ì €ì¥ëœ ì‹¤í—˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                            
                            list.forEach((item, idx) => {
                                console.log(`ì‹¤í—˜ ${idx + 1}:`, item);
                                const label = `${item.date || 'ë‚ ì§œ ì—†ìŒ'} | ${item.name || 'ì´ë¦„ ì—†ìŒ'} | ${item.age || 'ë‚˜ì´ ì—†ìŒ'}`;
                                const opt = document.createElement('option');
                                opt.value = item.filename || `ì‹¤í—˜${idx + 1}`;
                                opt.textContent = label;
                                select.appendChild(opt);
                                console.log('âœ… ì˜µì…˜ ì¶”ê°€ë¨:', label);
                            });
                            
                            console.log('âœ… ì‹¤í—˜ ëª©ë¡ ë¡œë“œ ì™„ë£Œ, ì´', list.length, 'ê°œ');
                        } else {
                            console.warn('âš ï¸ ì‹¤í—˜ ëª©ë¡ì´ ë¹„ì–´ìˆê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹˜');
                            select.innerHTML = '<option>ì €ì¥ëœ ì‹¤í—˜ì´ ì—†ìŠµë‹ˆë‹¤</option>';
                        }
                    } else {
                        console.error('âŒ Content-Typeì´ JSONì´ ì•„ë‹˜:', contentType);
                        const text = await res.text();
                        console.error('âŒ ì‘ë‹µ ë‚´ìš©:', text);
                        select.innerHTML = '<option>ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜</option>';
                    }
                } else {
                    console.error('âŒ API ì‘ë‹µ ì‹¤íŒ¨:', res.status, res.statusText);
                    const errorText = await res.text();
                    console.error('âŒ ì—ëŸ¬ ë‚´ìš©:', errorText);
                    select.innerHTML = '<option>API ì‘ë‹µ ì‹¤íŒ¨</option>';
                }
            } catch (e) {
                console.error('âŒ ì‹¤í—˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', e);
                console.error('âŒ ì—ëŸ¬ ìƒì„¸:', e.message, e.stack);
                select.innerHTML = '<option>ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜</option>';
            }
        }

        // ì‹¤í—˜ íŒŒì¼ ì„ íƒ ì‹œ
        async function onExperimentChange() {
            console.log('ğŸš€ onExperimentChange í˜¸ì¶œë¨');
            const experimentFile = document.getElementById('experimentSelect').value;
            console.log('ì„ íƒëœ ì‹¤í—˜ íŒŒì¼:', experimentFile);
            if (!experimentFile) return;

            try {
                console.log('ğŸ“¡ /responses/' + experimentFile + ' API í˜¸ì¶œ ì¤‘...');
                // ì „ì²´ ì‹¤í—˜ ë°ì´í„°ë¥¼ ì§ì ‘ ë¡œë“œ (responses í´ë”ì—ì„œ)
                const res = await fetch(`/responses/${experimentFile}`);
                console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', res.status, res.ok);
                
                if (res.ok) {
                    const data = await res.json();
                    currentExperiment = data;
                    console.log('âœ… ì‹¤í—˜ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', data);
                    console.log('ì‹¤í—˜ ë°ì´í„° êµ¬ì¡° í™•ì¸:');
                    console.log('  - experiment_num:', data.experiment_num);
                    console.log('  - history í‚¤ ì¡´ì¬:', 'history' in data);
                    console.log('  - history ê¸¸ì´:', data.history ? data.history.length : 'undefined');
                    
                    if ('history' in data && data.history && data.history.length > 0) {
                        console.log('  - history[0] í‚¤ë“¤:', Object.keys(data.history[0]));
                        if ('answers' in data.history[0]) {
                            console.log('  - answers ê°œìˆ˜:', data.history[0].answers.length);
                            console.log('  - ì²« ë²ˆì§¸ answer êµ¬ì¡°:', data.history[0].answers[0]);
                        }
                        if ('question_text' in data.history[0]) {
                            console.log('  - question_text:', data.history[0].question_text);
                        }
                    }
                    
                    // ì§ˆë¬¸ê³¼ ì˜ë¯¸ì¶• ì„ íƒ ì´ˆê¸°í™”
                    document.getElementById('questionSelect').value = '';
                    document.getElementById('dimensionSelect').value = '';
                    currentQuestion = null;
                    currentDimension = null;
                    
                    // ì§ˆë¬¸ ëª©ë¡ ë¡œë“œ
                    loadQuestions(data);
                    
                    // í˜ë¥´ì†Œë‚˜ ëª©ë¡ ë¡œë“œ (Diffìš©)
                    loadPersonasForDiff();
                    
                    // ê¸°ì¡´ ì°¨íŠ¸ë“¤ ì´ˆê¸°í™”
                    clearVisualizations();
                    
                    // êµ¬ì¡°í™”ëœ ë¶„ì„ ì„¹ì…˜ í‘œì‹œ (í•˜ì§€ë§Œ ë‚´ìš©ì€ ë¹„ì–´ìˆìŒ)
                    const structuredSection = document.getElementById('structuredAnalysisSection');
                    console.log('structuredSection ì°¾ê¸° ì‹œë„:', structuredSection);
                    if (structuredSection) {
                        console.log('âœ… structuredSection ì°¾ìŒ, displayë¥¼ blockìœ¼ë¡œ ì„¤ì •');
                        structuredSection.style.display = 'block';
                        console.log('ì„¤ì • í›„ display ìƒíƒœ:', structuredSection.style.display);
                    } else {
                        console.error('âŒ structuredAnalysisSectionì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    }
                    
                    // Diff ì„¹ì…˜ì€ ê·¸ëŒ€ë¡œ ë‘ê³  í˜ë¥´ì†Œë‚˜ ëª©ë¡ë§Œ ë¡œë“œ
                    const diffSection = document.getElementById('diffSection');
                    if (diffSection) {
                        // Side-by-Side ì„¹ì…˜ì´ ë³´ì´ëŠ” ìƒíƒœë¼ë©´ í˜ë¥´ì†Œë‚˜ ëª©ë¡ ë¡œë“œ
                        if (diffSection.style.display !== 'none') {
                            loadPersonasForDiff();
                        }
                    }

                    // ìë™ ë¶„ì„ ë¹„í™œì„±í™” - ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ì‹œì‘
                    console.log('âœ… ì‹¤í—˜ ì„ íƒ ì™„ë£Œ - ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”');
                } else {
                    console.error('âŒ ì‹¤í—˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', res.status, res.statusText);
                    const errorText = await res.text();
                    console.error('âŒ ì—ëŸ¬ ë‚´ìš©:', errorText);
                    alert('ì‹¤í—˜ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (e) {
                console.error('âŒ ì‹¤í—˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                console.error('âŒ ì—ëŸ¬ ìƒì„¸:', e.message, e.stack);
                alert('ì‹¤í—˜ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            }
        }

        // ì§ˆë¬¸ ëª©ë¡ ë¡œë“œ
        function loadQuestions(experimentData) {
            const select = document.getElementById('questionSelect');
            select.innerHTML = '<option value="">ì§ˆë¬¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';
            
            console.log('ì§ˆë¬¸ ë¡œë“œ ì‹œì‘:', experimentData);
            
            // questions.jsonì—ì„œ ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ
            fetch('/static/questions.json')
                .then(response => response.json())
                .then(questionsData => {
                    console.log('ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', questionsData);
                    
                    // ì „ì—­ questions ë³€ìˆ˜ì— ì €ì¥
                    questions = questionsData.map(q => q.text || '');
                    console.log('âœ… ì „ì—­ questions ë³€ìˆ˜ ì„¤ì •ë¨:', questions);
                    
                    questionsData.forEach((q, idx) => {
                        const opt = document.createElement('option');
                        opt.value = idx;
                        opt.textContent = q.text || `ì§ˆë¬¸ ${idx + 1}`;
                        select.appendChild(opt);
                    });
                })
                .catch(error => {
                    console.error('ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    // ëŒ€ì²´ ë°©ë²•: experimentDataì—ì„œ ì§ˆë¬¸ ì¶”ì¶œ ì‹œë„
                    if (experimentData.history && experimentData.history.length > 0) {
                        const firstHistory = experimentData.history[0];
                        if (firstHistory.answers && firstHistory.answers.length > 0) {
                            // answers êµ¬ì¡°ì—ì„œ ì§ˆë¬¸ ì¶”ì¶œ
                            firstHistory.answers.forEach((answer, idx) => {
                                const opt = document.createElement('option');
                                opt.value = idx;
                                opt.textContent = `ì§ˆë¬¸ ${idx + 1}`;
                                select.appendChild(opt);
                            });
                            
                            // ì „ì—­ questions ë³€ìˆ˜ì— ê¸°ë³¸ê°’ ì„¤ì •
                            questions = Array.from({length: firstHistory.answers.length}, (_, i) => `ì§ˆë¬¸ ${i + 1}`);
                            console.log('âœ… ì „ì—­ questions ë³€ìˆ˜ ì„¤ì •ë¨ (ê¸°ë³¸ê°’):', questions);
                        } else if (firstHistory.prompts && firstHistory.prompts.length > 0) {
                            // prompts êµ¬ì¡°ì—ì„œ ì§ˆë¬¸ ì¶”ì¶œ
                            firstHistory.prompts.forEach((prompt, idx) => {
                                if (prompt.qa && prompt.qa.length > 0) {
                                    prompt.qa.forEach((qa, qaIdx) => {
                                        const opt = document.createElement('option');
                                        opt.value = `${idx}_${qaIdx}`;
                                        opt.textContent = qa.question || `ì§ˆë¬¸ ${idx + 1}_${qaIdx + 1}`;
                                        select.appendChild(opt);
                                    });
                                }
                            });
                            
                            // ì „ì—­ questions ë³€ìˆ˜ì— ê¸°ë³¸ê°’ ì„¤ì •
                            questions = Array.from({length: firstHistory.prompts.length}, (_, i) => `ì§ˆë¬¸ ${i + 1}`);
                            console.log('âœ… ì „ì—­ questions ë³€ìˆ˜ ì„¤ì •ë¨ (ê¸°ë³¸ê°’):', questions);
                        }
                    }
                });
        }

        // ì§ˆë¬¸ ë³€ê²½ ì‹œ
        function onQuestionChange() {
            const newQuestion = document.getElementById('questionSelect').value;
            console.log('ì§ˆë¬¸ ë³€ê²½ ê°ì§€:', currentQuestion, 'â†’', newQuestion);
            
            if (newQuestion !== currentQuestion) {
                currentQuestion = newQuestion;
                if (currentQuestion !== '') {
                    clearVisualizations();
                    // ìë™ ë¶„ì„ ë¹„í™œì„±í™” - ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ì‹œì‘
                    console.log('âœ… ì§ˆë¬¸ ì„ íƒ ì™„ë£Œ - ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”');
                } else {
                    // ì§ˆë¬¸ì´ ì„ íƒ í•´ì œëœ ê²½ìš°
                    clearVisualizations();
                    console.log('ğŸ”„ ì§ˆë¬¸ ì„ íƒ í•´ì œë¨');
                }
            }
        }

        // ì˜ë¯¸ ì¶• ë³€ê²½ ì‹œ
        function onDimensionChange() {
            const newDimension = document.getElementById('dimensionSelect').value;
            console.log('ì˜ë¯¸ ì¶• ë³€ê²½ ê°ì§€:', currentDimension, 'â†’', newDimension);
            
            if (newDimension !== currentDimension) {
                currentDimension = newDimension;
                if (currentDimension !== '') {
                    clearVisualizations();
                    // ìë™ ë¶„ì„ ë¹„í™œì„±í™” - ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ì‹œì‘
                    console.log('âœ… ì˜ë¯¸ ì¶• ì„ íƒ ì™„ë£Œ - ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”');
                } else {
                    // ì˜ë¯¸ ì¶•ì´ ì„ íƒ í•´ì œëœ ê²½ìš°
                    clearVisualizations();
                    console.log('ğŸ”„ ì˜ë¯¸ ì¶• ì„ íƒ í•´ì œë¨');
                }
            }
        }

        // ìë™ ë¶„ì„ í•¨ìˆ˜ëŠ” ë¹„í™œì„±í™”ë¨ - ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ë§Œ ì‹œì‘
        // function autoStartAnalysis() { ... }

        // ë¡œë”© ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        let loadingStates = {
            sortingChart: false,
            sortingList: false,
            structuredAnalysis: false
        };

        function showLoading() {
            loadingStates.sortingChart = true;
            loadingStates.sortingList = true;
            loadingStates.structuredAnalysis = true;
            
            // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ (ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
            const sortingChartLoading = document.getElementById('sortingChartLoading');
            const sortingListLoading = document.getElementById('sortingListLoading');
            const structuredAnalysisLoading = document.getElementById('structuredAnalysisLoading');
            
            if (sortingChartLoading) sortingChartLoading.style.display = 'inline-block';
            if (sortingListLoading) sortingListLoading.style.display = 'inline-block';
            if (structuredAnalysisLoading) structuredAnalysisLoading.style.display = 'inline-block';
            
            // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆì— ë¡œë”© í´ë˜ìŠ¤ ì¶”ê°€ (ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
            const chartContainer = document.querySelector('.chart-container');
            const sortingListSection = document.getElementById('sortingListSection');
            const structuredAnalysisContent = document.getElementById('structuredAnalysisContent');
            
            if (chartContainer) chartContainer.classList.add('loading');
            if (sortingListSection) sortingListSection.classList.add('loading');
            if (structuredAnalysisContent) structuredAnalysisContent.classList.add('loading');
            
            console.log('ğŸ”„ ë¡œë”© ì‹œì‘ - ëª¨ë“  ì‹œê°í™”');
        }

        function hideLoading() {
            loadingStates.sortingChart = false;
            loadingStates.sortingList = false;
            loadingStates.structuredAnalysis = false;
            
            // ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¹€ (ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
            const sortingChartLoading = document.getElementById('sortingChartLoading');
            const sortingListLoading = document.getElementById('sortingListLoading');
            const structuredAnalysisLoading = document.getElementById('structuredAnalysisLoading');
            
            if (sortingChartLoading) sortingChartLoading.style.display = 'none';
            if (sortingListLoading) sortingListLoading.style.display = 'none';
            if (structuredAnalysisLoading) structuredAnalysisLoading.style.display = 'none';
            
            console.log('âœ… ë¡œë”© ì™„ë£Œ - ëª¨ë“  ì‹œê°í™”');
        }

        function hideSpecificLoading(type) {
            if (type === 'sortingChart') {
                loadingStates.sortingChart = false;
                document.getElementById('sortingChartLoading').style.display = 'none';
                document.querySelector('.chart-container').classList.remove('loading');
                console.log('âœ… ì •ë ¬ ì°¨íŠ¸ ë¡œë”© ì™„ë£Œ');
            } else if (type === 'sortingList') {
                loadingStates.sortingList = false;
                document.getElementById('sortingListLoading').style.display = 'none';
                document.getElementById('sortingListSection').classList.remove('loading');
                console.log('âœ… ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ë¡œë”© ì™„ë£Œ');
            } else if (type === 'structuredAnalysis') {
                loadingStates.structuredAnalysis = false;
                document.getElementById('structuredAnalysisLoading').style.display = 'none';
                document.getElementById('structuredAnalysisContent').classList.remove('loading');
                console.log('âœ… êµ¬ì¡°í™”ëœ ë¶„ì„ ë¡œë”© ì™„ë£Œ');
            }
            
            // ëª¨ë“  ë¡œë”©ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!loadingStates.sortingChart && !loadingStates.sortingList && !loadingStates.structuredAnalysis) {
                console.log('ğŸ‰ ëª¨ë“  ë¶„ì„ ì™„ë£Œ!');
            }
        }

        // í†µí•© ë¶„ì„ ì‹œì‘ (ì‹œê°í™” + êµ¬ì¡°í™”ëœ ë¶„ì„)
        function startCompleteAnalysis() {
            // í˜„ì¬ ì„ íƒëœ ê°’ë“¤ì„ ë‹¤ì‹œ í™•ì¸
            const selectedExperiment = document.getElementById('experimentSelect').value;
            const selectedQuestion = document.getElementById('questionSelect').value;
            const selectedDimension = document.getElementById('dimensionSelect').value;
            
            console.log('í˜„ì¬ ì„ íƒëœ ê°’ë“¤ í™•ì¸:', {
                experiment: selectedExperiment,
                question: selectedQuestion,
                dimension: selectedDimension
            });
            
            // ê°’ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            if (selectedQuestion !== currentQuestion) {
                currentQuestion = selectedQuestion;
                console.log('ğŸ”„ currentQuestion ì—…ë°ì´íŠ¸ë¨:', currentQuestion);
            }
            if (selectedDimension !== currentDimension) {
                currentDimension = selectedDimension;
                console.log('ğŸ”„ currentDimension ì—…ë°ì´íŠ¸ë¨:', currentDimension);
            }
            
            if (!currentExperiment || currentQuestion === null || !currentDimension) {
                alert('ì‹¤í—˜, ì§ˆë¬¸, ì˜ë¯¸ ì¶•ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('ğŸš€ í†µí•© ë¶„ì„ ì‹œì‘:', {
                experiment: currentExperiment,
                question: currentQuestion,
                dimension: currentDimension
            });

            // ë¡œë”© í‘œì‹œ ì‹œì‘
            showLoading();

            console.log('ğŸ“‹ ë¶„ì„ ìˆœì„œ: 1ë‹¨ê³„(ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸) â†’ 2ë‹¨ê³„(êµ¬ì¡°í™”ëœ ë¶„ì„)');

            // 1ë‹¨ê³„: ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ë¨¼ì € ìƒì„± (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘)
            try {
                console.log('1ë‹¨ê³„ ì‹œì‘: ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ìƒì„±');
                
                // ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ì„¹ì…˜ í‘œì‹œ
                const sortingListSection = document.getElementById('sortingListSection');
                if (sortingListSection) {
                    sortingListSection.style.display = 'block';
                    console.log('âœ… sortingListSection í‘œì‹œë¨');
                }
                
                // ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ìƒì„±
                generateSortingList();
                console.log('âœ… 1ë‹¨ê³„ ì™„ë£Œ: ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸');
                
                // 1ë‹¨ê³„ ì™„ë£Œ í›„ ë¡œë”© í‘œì‹œ ì œê±°
                hideLoading();
                console.log('âœ… 1ë‹¨ê³„ ë¡œë”© í‘œì‹œ ì œê±°ë¨');
                
                // 2ë‹¨ê³„: ë°±ì—”ë“œì—ì„œ êµ¬ì¡°í™”ëœ ë¶„ì„ ì‹œì‘
                console.log('ğŸ”„ 2ë‹¨ê³„ ì‹œì‘: ë°±ì—”ë“œ êµ¬ì¡°í™”ëœ ë¶„ì„');
                generateStructuredAnalysis();
            } catch (error) {
                console.error('âŒ 1ë‹¨ê³„ ì‹¤íŒ¨:', error);
                console.log('ğŸ”„ 2ë‹¨ê³„ ì‹œì‘: êµ¬ì¡°í™”ëœ ë¶„ì„ (1ë‹¨ê³„ ì‹¤íŒ¨ í›„)');
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ êµ¬ì¡°í™”ëœ ë¶„ì„ì€ ì‹œë„
                generateStructuredAnalysis();
            }
        }

        // ì‹œê°í™” ì‹œì‘ (ê¸°ì¡´ í•¨ìˆ˜ - í˜¸í™˜ì„± ìœ ì§€)
        function startVisualization() {
            startCompleteAnalysis();
        }

        // ë°±ì—”ë“œì—ì„œ ì‹œê°í™” ìƒì„±
        async function generateVisualizationsFromBackend() {
            try {
                const requestData = {
                    experiment_data: currentExperiment,
                    question_index: parseInt(currentQuestion),
                    dimension: currentDimension,
                    analysis_type: "all",
                    // heatmap_type: document.getElementById('heatmapTypeSelect').value
                };

                console.log('í”„ë¡ íŠ¸ì—”ë“œ ë””ë²„ê¹…: currentExperiment =', currentExperiment);
                console.log('í”„ë¡ íŠ¸ì—”ë“œ ë””ë²„ê¹…: currentQuestion =', currentQuestion);
                console.log('í”„ë¡ íŠ¸ì—”ë“œ ë””ë²„ê¹…: currentDimension =', currentDimension);
                console.log('í”„ë¡ íŠ¸ì—”ë“œ ë””ë²„ê¹…: requestData =', requestData);

                const response = await fetch('/visualization/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('ë°±ì—”ë“œ ì‹œê°í™” ê²°ê³¼:', result);
                    
                    if (result.success) {
                        // ìºì‹œì—ì„œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì½˜ì†”ì—ë§Œ ë¡œê·¸, ì‚¬ìš©ìì—ê²ŒëŠ” ì•Œë¦¼í•˜ì§€ ì•ŠìŒ)
                        if (result.loaded_from_cache) {
                            console.log('âœ… ê¸°ì¡´ ë¶„ì„ ê²°ê³¼ë¥¼ ìºì‹œì—ì„œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤');
                        } else {
                            console.log('ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤');
                        }
                        
                        displayBackendVisualizations(result.data);
                        // ì‹œê°í™” ë¡œë”© ì™„ë£Œ
                        hideSpecificLoading('sortingChart');
                        hideSpecificLoading('sortingList');
                        
                        // ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë¨ì„ ì•Œë¦¼
                        return Promise.resolve();
                    } else {
                        throw new Error(result.message || 'ì‹œê°í™” ìƒì„± ì‹¤íŒ¨');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ë°±ì—”ë“œ ì‹œê°í™” ìƒì„± ì‹¤íŒ¨:', error);
                
                // ì‹œê°í™” ë¡œë”© ì™„ë£Œ (ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„)
                hideSpecificLoading('sortingChart');
                hideSpecificLoading('sortingList');
                
                // ë” ìì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                let errorMessage = 'ì‹œê°í™” ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message;
                if (error.message.includes('answers ë°°ì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤')) {
                    errorMessage = 'ì‹œê°í™” ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ì„ íƒí•œ ì‹¤í—˜ì˜ ì‘ë‹µ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‹¤í—˜ì„ ì„ íƒí•˜ê±°ë‚˜ ì‘ë‹µ ë°ì´í„°ê°€ ìˆëŠ” ì‹¤í—˜ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                }
                alert(errorMessage);
                
                // ë°±ì—”ë“œ ì‹¤íŒ¨ ì‹œ í”„ë¡ íŠ¸ì—”ë“œ ì‹œê°í™”ë¡œ ëŒ€ì²´
                // generateRadarChart();
                // generateHeatmap();
                generateSortingList();
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ Promise.resolve() ë°˜í™˜ (êµ¬ì¡°í™”ëœ ë¶„ì„ ì§„í–‰)
                return Promise.resolve();
            }
        }

        // ë°±ì—”ë“œ ì‹œê°í™” ê²°ê³¼ í‘œì‹œ
        function displayBackendVisualizations(data) {
                            console.log('ë°±ì—”ë“œ ì‹œê°í™” ë°ì´í„°:', data);
            
            // ë ˆì´ë” ì°¨íŠ¸ í‘œì‹œ
            /* if (data.radar_chart) {
                displayRadarChart(data.radar_chart);
            } */
            
            // íˆíŠ¸ë§µ í‘œì‹œ
            /* if (data.heatmap) {
                const heatmapType = data.heatmap_type || "seaborn";
                displayHeatmap(data.heatmap, heatmapType);
            } */
            
            // ì •ë ¬ ì°¨íŠ¸ í‘œì‹œ
            if (data.sorting_chart) {
                console.log('ì •ë ¬ ì°¨íŠ¸ ë°ì´í„°:', data.sorting_chart);
                displaySortingChart(data.sorting_chart);
            } else {
                console.log('âŒ ì •ë ¬ ì°¨íŠ¸ ë°ì´í„° ì—†ìŒ');
            }
            
            // ì •ë ¬ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
            if (data.sorting_list) {
                console.log('ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ë°ì´í„°:', data.sorting_list);
                displaySortingList(data.sorting_list);
            } else {
                console.log('âŒ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì—†ìŒ');
            }
        }

        // ë°±ì—”ë“œ ë ˆì´ë” ì°¨íŠ¸ í‘œì‹œ
        /* function displayRadarChart(chartData) {
            const container = document.getElementById('radarChart');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (currentRadarChart) {
                Plotly.purge('radarChart');
                currentRadarChart = null;
            }
            
            // Plotlyë¡œ ì°¨íŠ¸ ìƒì„±
            Plotly.newPlot('radarChart', chartData.data, chartData.layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            }).then(() => {
                currentRadarChart = true;
            });
        } */

        // ë°±ì—”ë“œ íˆíŠ¸ë§µ í‘œì‹œ
        /* function displayHeatmap(heatmapData, heatmapType = "seaborn") {
            const container = document.getElementById('heatmapContent');
            
            if (heatmapType === "plotly") {
                // Plotly íˆíŠ¸ë§µ í‘œì‹œ
                container.innerHTML = '<div id="plotlyHeatmap" style="width: 100%; height: 500px;"></div>';
                
                // Plotlyë¡œ ì°¨íŠ¸ ìƒì„±
                Plotly.newPlot('plotlyHeatmap', heatmapData.data, heatmapData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false
                });
            } else {
                // Seaborn íˆíŠ¸ë§µ (base64 ì´ë¯¸ì§€) í‘œì‹œ
                container.innerHTML = `
                    <div style="text-align: center;">
                        <h4 style="margin-bottom: 20px; color: color: #495057;">í˜ë¥´ì†Œë‚˜ë³„ ì˜ë¯¸ ë¶„ì„ íˆíŠ¸ë§µ</h4>
                        <img src="data:image/png;base64,${heatmapData}" 
                             alt="íˆíŠ¸ë§µ" 
                             style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />
                </div>
            `;
            }
        } */

        // ë°±ì—”ë“œ ì •ë ¬ ì°¨íŠ¸ í‘œì‹œ
        function displaySortingChart(chartData) {
                            console.log('ì •ë ¬ ì°¨íŠ¸ í‘œì‹œ ì‹œì‘:', chartData);
            const container = document.getElementById('sortingContent');
            
            if (!chartData || !chartData.data || !chartData.layout) {
                console.error('âŒ ì •ë ¬ ì°¨íŠ¸ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜:', chartData);
                return;
            }
            
            try {
                // Plotlyë¡œ ì°¨íŠ¸ ìƒì„±
                Plotly.newPlot('sortingContent', chartData.data, chartData.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    displaylogo: false
                });
                console.log('âœ… ì •ë ¬ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì •ë ¬ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
            }
        }

        // ë°±ì—”ë“œ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
        function displaySortingList(sortingData) {
                            console.log('ì •ë ¬ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì‹œì‘:', sortingData);
            const container = document.getElementById('sortingListContent');
            
            if (!sortingData || !sortingData.sorted_data) {
                console.error('âŒ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜:', sortingData);
                return;
            }
            
            try {
                let html = '<div class="sorting-list">';
                html += `<h4>${sortingData.dimension_name} ê¸°ì¤€ ì •ë ¬</h4>`;
                html += '<div class="sorting-items" id="sortingItemsContainer">';
                
                // ìƒìœ„ 3ê°œë§Œ ë¨¼ì € í‘œì‹œ
                const top3Items = sortingData.sorted_data.slice(0, 3);
                top3Items.forEach((item) => {
                    html += `
                        <div class="sorting-item top-rank">
                            <span class="rank">${item.rank}</span>
                            <span class="personality clickable-persona" onclick="goToPersonaDetail('${item.display_name}')">${item.display_name}</span>
                            <span class="value">${item.value}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // 4ìœ„ ì´í•˜ê°€ ìˆëŠ” ê²½ìš° ë”ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
                if (sortingData.sorted_data.length > 3) {
                    html += `
                        <div class="show-more-container" style="text-align: center; margin-top: 20px;">
                            <button id="showMoreBtn" class="show-more-btn" onclick="toggleSortingList()">
                                ğŸ“‹ ë”ë³´ê¸° (${sortingData.sorted_data.length - 3}ê°œ ë”)
                            </button>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            
            // ì •ë ¬ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (ë”ë³´ê¸° ê¸°ëŠ¥ìš©)
            window.currentSortingData = sortingData;
            
            // ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('sortingListSection').style.display = 'block';
            
            // ê° ì‘ë‹µ í…ìŠ¤íŠ¸ì— íƒœê·¸ í•˜ì´ë¼ì´íŠ¸ ì ìš©
            personaResponses.forEach((pr, index) => {
                const highlightedContainer = document.getElementById(`highlightedText_${index}`);
                if (highlightedContainer) {
                    highlightedContainer.innerHTML = highlightTagsInText(pr.text, pr.tags);
                }
            });
            
            console.log('âœ… ì •ë ¬ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì‹¤íŒ¨:', error);
            }
        }

        // ì„ íƒëœ ì§ˆë¬¸ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        function getSelectedQuestionText() {
            console.log('getSelectedQuestionText í˜¸ì¶œë¨');
            console.log('currentQuestion:', currentQuestion);
            console.log('questions:', questions);
            console.log('questions ê¸¸ì´:', questions ? questions.length : 'undefined');
            
            if (currentQuestion === null || currentQuestion === '') {
                console.log('âš ï¸ currentQuestionì´ nullì´ê±°ë‚˜ ë¹ˆ ë¬¸ìì—´');
                return 'ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
            }
            
            if (!questions || !Array.isArray(questions)) {
                console.log('âš ï¸ questionsê°€ ë°°ì—´ì´ ì•„ë‹˜');
                return `ì§ˆë¬¸ ${parseInt(currentQuestion) + 1}`;
            }
            
            if (!questions[currentQuestion]) {
                console.log('âš ï¸ questions[currentQuestion]ì´ ì—†ìŒ');
                return `ì§ˆë¬¸ ${parseInt(currentQuestion) + 1}`;
            }
            
            // questions ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ì§ˆë¬¸ í…ìŠ¤íŠ¸ ë°˜í™˜
            const questionText = questions[currentQuestion];
            console.log(`âœ… ì„ íƒëœ ì§ˆë¬¸ í…ìŠ¤íŠ¸: ${questionText}`);
            return questionText;
        }

        // í˜ë¥´ì†Œë‚˜ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        function goToPersonaDetail(personaName) {
            console.log('goToPersonaDetail í˜¸ì¶œë¨:', personaName);
            console.log('currentExperiment:', currentExperiment);
            
            if (!currentExperiment) {
                alert('ë¨¼ì € ì‹¤í—˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const experimentName = currentExperiment.replace('.json', '');
            const url = `/persona-detail?persona=${encodeURIComponent(personaName)}&experiment=${encodeURIComponent(experimentName)}&file=${encodeURIComponent(currentExperiment)}`;
            
            console.log('ì´ë™í•  URL:', url);
            
            // ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
            try {
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    console.log('âœ… ìƒˆ íƒ­ ì—´ê¸° ì„±ê³µ');
                } else {
                    console.error('âŒ ìƒˆ íƒ­ ì—´ê¸° ì‹¤íŒ¨ - íŒì—… ì°¨ë‹¨ë¨');
                    alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('âŒ ìƒˆ íƒ­ ì—´ê¸° ì¤‘ ì˜¤ë¥˜:', error);
                alert('í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ë”ë³´ê¸°/ì ‘ê¸° í† ê¸€
        function toggleSortingList() {
            const container = document.getElementById('sortingItemsContainer');
            const showMoreBtn = document.getElementById('showMoreBtn');
            const sortingData = window.currentSortingData; // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
            
            if (!sortingData) {
                console.error('âŒ ì •ë ¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const isExpanded = container.getAttribute('data-expanded') === 'true';
            
            if (!isExpanded) {
                // ì „ì²´ ëª©ë¡ í‘œì‹œ
                let html = '';
                sortingData.forEach((item, index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? 'top-rank' : '';
                    console.log(`ì „ì²´ ëª©ë¡ í˜ë¥´ì†Œë‚˜ ì•„ì´í…œ ìƒì„±: ${item.personality}`);
                    html += `
                        <div class="sorting-item ${rankClass}">
                            <span class="rank">${rank}</span>
                            <span class="personality">${item.personality}</span>
                            <span class="value">${item.value.toFixed(2)}</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
                container.setAttribute('data-expanded', 'true');
                showMoreBtn.innerHTML = 'ğŸ“‹ ì ‘ê¸°';
                showMoreBtn.style.backgroundColor = '#6c757d';
            } else {
                // ìƒìœ„ 3ê°œë§Œ í‘œì‹œ
                let html = '';
                const top3Items = sortingData.slice(0, 3);
                top3Items.forEach((item, index) => {
                    const rank = index + 1;
                    html += `
                        <div class="sorting-item top-rank">
                            <span class="rank">${rank}</span>
                            <span class="personality">${item.personality}</span>
                            <span class="value">${item.value.toFixed(2)}</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
                container.setAttribute('data-expanded', 'false');
                showMoreBtn.innerHTML = `ğŸ“‹ ë”ë³´ê¸° (${sortingData.length - 3}ê°œ ë”)`;
                showMoreBtn.style.backgroundColor = '#007bff';
            }
        }

        // ë ˆì´ë” ì°¨íŠ¸ ìƒì„±
        /* function generateRadarChart() {
            const container = document.getElementById('radarChart');
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (currentRadarChart) {
                Plotly.purge('radarChart');
                currentRadarChart = null;
            }

            // ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì°¨íŠ¸ ìƒì„±
            const data = generateRadarDataFromExperiment();
            
            const layout = {
                polar: {
                    radialaxis: {
                        visible: true,
                        range: [0, 5],
                        tickmode: 'array',
                        tickvals: [0, 1, 2, 3, 4, 5],
                        ticktext: ['0', '1', '2', '3', '4', '5'],
                        tickfont: { size: 12 },
                        tickcolor: '#666'
                    },
                    angularaxis: {
                        tickfont: { size: 14, weight: 'bold' },
                        tickcolor: '#333'
                    },
                    bgcolor: '#f8f9fa'
                },
                        title: {
                    text: `ì§ˆë¬¸ ${parseInt(currentQuestion) + 1}: ${getQuestionText(currentQuestion)}`,
                    font: { size: 18, weight: 'bold' },
                    x: 0.5,
                    y: 0.95
                },
                showlegend: true,
                        legend: {
                    x: 0.5,
                    y: 0.85,
                    xanchor: 'center',
                    yanchor: 'top',
                    orientation: 'h',
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#ccc',
                    borderwidth: 1
                },
                plot_bgcolor: '#ffffff',
                paper_bgcolor: '#ffffff',
                margin: { t: 100, b: 50, l: 50, r: 50 },
                height: 500
            };
            
            Plotly.newPlot('radarChart', data, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                displaylogo: false
            }).then(() => {
                currentRadarChart = true;
            });
        } */

        // ì‹¤í—˜ ë°ì´í„°ì—ì„œ ë ˆì´ë” ì°¨íŠ¸ ë°ì´í„° ìƒì„±
        function generateRadarDataFromExperiment() {
            if (!currentExperiment || !currentExperiment.prompts) {
                return generateSampleRadarData();
            }

            try {
                const labels = [];
                const datasets = [];
                
                // ì˜ë¯¸ ì¶•ì— ë”°ë¥¸ ë¼ë²¨ ìƒì„±
                if (currentDimension.startsWith('temperament_')) {
                    const dimensionKey = currentDimension.replace('temperament_', '');
                    labels.push(dimensionKey);
                } else if (currentDimension.startsWith('character_')) {
                    const dimensionKey = currentDimension.replace('character_', '');
                    labels.push(dimensionKey);
                } else {
                    labels.push(currentDimension);
                }

                // í˜ë¥´ì†Œë‚˜ë³„ ë°ì´í„° ìˆ˜ì§‘
                const personalities = [];
                currentExperiment.prompts.forEach(prompt => {
                    if (prompt.personality && !personalities.includes(prompt.personality)) {
                        personalities.push(prompt.personality);
                    }
                });

                // ê° í˜ë¥´ì†Œë‚˜ë³„ ë°ì´í„°ì…‹ ìƒì„±
                personalities.forEach((personality, index) => {
                    const color = getColorForIndex(index);
                    const data = [];
                    
                    // ì˜ë¯¸ ì¶•ì— ë”°ë¥¸ ê°’ ê³„ì‚°
                    if (currentDimension.startsWith('temperament_') || currentDimension.startsWith('character_')) {
                        // ì„±ê²© ë°ì´í„°ì—ì„œ ì‹¤ì œ ê°’ ì¶”ì¶œ
                        const value = extractPersonalityValue(personality, currentDimension);
                        data.push(value);
                    } else {
                        // ì‘ë‹µ ë¶„ì„ ê¸°ë°˜ ê°’ ê³„ì‚°
                        const value = analyzeResponseValue(personality, currentDimension);
                        data.push(value);
                    }

                    datasets.push({
                        type: 'scatterpolar',
                        mode: 'lines+markers',
                        name: personality,
                        r: data,
                        theta: labels,
                        line: {
                            color: color,
                            width: 3
                        },
                        marker: {
                            color: color,
                            size: 10,
                            symbol: 'circle'
                        },
                        fill: 'toself',
                        fillcolor: color + '40',
                        opacity: 0.6,
                        hoverinfo: 'text+name',
                        hovertext: `${personality}<br>${getDimensionDisplayName(currentDimension)}: ${data[0].toFixed(2)}`,
                        hovertemplate: '<b>%{fullData.name}</b><br>' +
                                     `${getDimensionDisplayName(currentDimension)}: %{r}<br>` +
                                     '<extra></extra>'
                    });
                });

                return datasets;
            } catch (error) {
                console.error('ë ˆì´ë” ì°¨íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨:', error);
                return generateSampleRadarData();
            }
        }

        // ì„±ê²© ë°ì´í„°ì—ì„œ ê°’ ì¶”ì¶œ
        function extractPersonalityValue(personality, dimension) {
            try {
                if (dimension.startsWith('temperament_')) {
                    const key = dimension.replace('temperament_', '');
                    // personality.jsonì—ì„œ í•´ë‹¹ ê¸°ì§ˆ ê°’ ì°¾ê¸°
                    return Math.random() * 5; // ì„ì‹œë¡œ ëœë¤ ê°’ ë°˜í™˜
                } else if (dimension.startsWith('character_')) {
                    const key = dimension.replace('character_', '');
                    // personality.jsonì—ì„œ í•´ë‹¹ ì„±ê²© ê°’ ì°¾ê¸°
                    return Math.random() * 5; // ì„ì‹œë¡œ ëœë¤ ê°’ ë°˜í™˜
                }
                return Math.random() * 5;
            } catch (error) {
                console.error('ì„±ê²© ê°’ ì¶”ì¶œ ì‹¤íŒ¨:', error);
                return Math.random() * 5;
            }
        }

        // ì‘ë‹µ ë¶„ì„ ê¸°ë°˜ ê°’ ê³„ì‚°
        function analyzeResponseValue(personality, dimension) {
            try {
                // í˜„ì¬ ì„ íƒëœ ì§ˆë¬¸ì— ëŒ€í•œ ì‘ë‹µ ì°¾ê¸°
                const questionIndex = parseInt(currentQuestion);
                const response = findResponseForQuestion(personality, questionIndex);
                
                if (!response) return Math.random() * 5;

                switch (dimension) {
                    case 'emotional_intensity':
                        return analyzeEmotionIntensity(response);
                    case 'valence':
                        return analyzeValence(response);
                    case 'expression_type':
                        return analyzeExpressionType(response);
                    case 'agency':
                        return analyzeAgency(response);
                    case 'extroversion':
                        return analyzeExtroversion(response);
                    case 'solution_offered':
                        return analyzeSolutionOffered(response);
                    case 'response_length':
                        return Math.min(response.length / 50, 5); // ì‘ë‹µ ê¸¸ì´ ê¸°ë°˜
                    case 'complexity':
                        return analyzeComplexity(response);
                    default:
                        return Math.random() * 5;
                }
            } catch (error) {
                console.error('ì‘ë‹µ ë¶„ì„ ì‹¤íŒ¨:', error);
                return Math.random() * 5;
            }
        }

        // ì§ˆë¬¸ì— ëŒ€í•œ ì‘ë‹µ ì°¾ê¸°
        function findResponseForQuestion(personality, questionIndex) {
            console.log('findResponseForQuestion ì‹œì‘:', personality, questionIndex);
            console.log('currentExperiment êµ¬ì¡°:', Object.keys(currentExperiment));
            
            if (!currentExperiment || !currentExperiment.history) {
                console.error('âŒ currentExperiment.historyê°€ ì—†ìŠµë‹ˆë‹¤');
                return null;
            }
            
            // ëª¨ë“  history í•­ëª©ì—ì„œ í•´ë‹¹ ì§ˆë¬¸ê³¼ í˜ë¥´ì†Œë‚˜ì— ë§ëŠ” ì‘ë‹µ ì°¾ê¸°
            for (let historyIdx = 0; historyIdx < currentExperiment.history.length; historyIdx++) {
                const historyItem = currentExperiment.history[historyIdx];
                console.log(`history[${historyIdx}] êµ¬ì¡°:`, Object.keys(historyItem));
                
                // í•´ë‹¹ ì§ˆë¬¸ì¸ì§€ í™•ì¸
                if (historyItem.question_text) {
                    console.log(`ì§ˆë¬¸ í…ìŠ¤íŠ¸: ${historyItem.question_text}`);
                    
                    // answersì—ì„œ í•´ë‹¹ í˜ë¥´ì†Œë‚˜ì˜ ì‘ë‹µ ì°¾ê¸°
                    if (historyItem.answers && historyItem.answers.length > 0) {
                        for (const answer of historyItem.answers) {
                            if (answer.personality === personality) {
                                console.log('âœ… í•´ë‹¹ í˜ë¥´ì†Œë‚˜ì™€ ì§ˆë¬¸ì—ì„œ ì‘ë‹µ ì°¾ìŒ:', answer.answer);
                                return answer.answer;
                            }
                        }
                    }
                }
            }
            
            // ë°±ì—…: promptsì—ì„œë„ ì‘ë‹µ ì°¾ê¸°
            const firstHistory = currentExperiment.history[0];
            if (firstHistory.prompts && firstHistory.prompts.length > 0) {
                for (const prompt of firstHistory.prompts) {
                    if (prompt.personality === personality && prompt.qa && prompt.qa[questionIndex]) {
                        console.log('âœ… promptsì—ì„œ ì‘ë‹µ ì°¾ìŒ:', prompt.qa[questionIndex].answer);
                        return prompt.qa[questionIndex].answer;
                    }
                }
            }
            
            console.log('âŒ ì‘ë‹µì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return null;
        }

        // ì§ˆë¬¸ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        function getQuestionText(questionIndex) {
            const questionSelect = document.getElementById('questionSelect');
            const option = questionSelect.options[questionSelect.selectedIndex];
            return option ? option.textContent : `ì§ˆë¬¸ ${parseInt(questionIndex) + 1}`;
        }

        // ê°ì • ê°•ë„ ë¶„ì„
        function analyzeEmotionIntensity(text) {
            const emotionWords = ['í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±'];
            const intensity = emotionWords.reduce((score, word) => {
                const count = (text.match(new RegExp(word, 'g')) || []).length;
                return score + count * 0.5;
            }, 0);
            return Math.min(intensity, 5);
        }

        // ì •ì„œ ë°©í–¥ ë¶„ì„
        function analyzeValence(text) {
            const positiveWords = ['ì¢‹ìŒ', 'ê¸°ì¨', 'í–‰ë³µ', 'ë§Œì¡±', 'í™”ë ¤í•¨', 'ì¦ê±°ì›€', 'í¬ë§', 'í¥ë¯¸ë¡œì›€'];
            const negativeWords = ['ë‚˜ì¨', 'ìŠ¬í””', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ë¶ˆë§Œ', 'ì§œì¦', 'í”¼ê³¤í•¨', 'ì§€ë£¨í•¨'];

            const positiveScore = positiveWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);
            const negativeScore = negativeWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);

            return Math.min(positiveScore - negativeScore, 5);
        }

        // í‘œí˜„ ìŠ¤íƒ€ì¼ ë¶„ì„
        function analyzeExpressionType(text) {
            const expressiveWords = ['í™œë°œ', 'ì¦ê±°ì›€', 'í¥ë¯¸ë¡œì›€', 'í™”ë ¤í•¨', 'ì¦ê±°ì›€', 'í¬ë§', 'í¥ë¯¸ë¡œì›€', 'í™”ë ¤í•¨'];
            const reservedWords = ['ì¡°ìš©', 'ì§€ë£¨', 'í”¼ê³¤', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ë¶ˆë§Œ', 'ì§œì¦', 'í”¼ê³¤'];

            const expressiveScore = expressiveWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);
            const reservedScore = reservedWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);

            return Math.min(expressiveScore - reservedScore, 5);
        }

        // ìê¸° ì£¼ë„ì„± ë¶„ì„
        function analyzeAgency(text) {
            const selfDirectedWords = ['ë‚˜', 'ë‚´', 'ì €', 'ì œ', 'ìš°ë¦¬', 'ìš°ë¦¬ë“¤', 'ë„ˆ', 'ë„ˆí¬', 'ë„ˆí¬ë“¤'];
            const otherDirectedWords = ['ë„ˆ', 'ë„ˆí¬', 'ë„ˆí¬ë“¤', 'ê·¸', 'ê·¸ë“¤', 'ì´', 'ìš°ë¦¬', 'ìš°ë¦¬ë“¤'];

            const selfDirectedScore = selfDirectedWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);
            const otherDirectedScore = otherDirectedWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);

            return Math.min(selfDirectedScore - otherDirectedScore, 5);
        }

        // ì™¸í–¥ì„± ë¶„ì„
        function analyzeExtroversion(text) {
            const extrovertedWords = ['ì™¸í–¥', 'ì™¸í–¥ì ', 'ì™¸í–¥ì ì¸', 'ì™¸í–¥ì ìœ¼ë¡œ', 'ì™¸í–¥ì ì¸ ì‚¬ëŒ', 'ì™¸í–¥ì ì¸ ì‚¬ëŒë“¤', 'ì™¸í–¥ì ì¸ ì‚¬ëŒìœ¼ë¡œ', 'ì™¸í–¥ì ì¸ ì‚¬ëŒë“¤ë¡œ'];
            const introvertedWords = ['ë‚´í–¥', 'ë‚´í–¥ì ', 'ë‚´í–¥ì ì¸', 'ë‚´í–¥ì ìœ¼ë¡œ', 'ë‚´í–¥ì ì¸ ì‚¬ëŒ', 'ë‚´í–¥ì ì¸ ì‚¬ëŒë“¤', 'ë‚´í–¥ì ì¸ ì‚¬ëŒìœ¼ë¡œ', 'ë‚´í–¥ì ì¸ ì‚¬ëŒë“¤ë¡œ'];

            const extrovertedScore = extrovertedWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);
            const introvertedScore = introvertedWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);

            return Math.min(extrovertedScore - introvertedScore, 5);
        }

        // í•´ê²° ì „ëµ ì œì‹œ ë¶„ì„
        function analyzeSolutionOffered(text) {
            const solutionWords = ['í•´ê²°', 'í•´ê²°ì±…', 'í•´ê²°ë°©ì•ˆ', 'í•´ê²°ì±… ì œì‹œ', 'í•´ê²°ì±… ì œì‹œí•˜ë‹¤', 'í•´ê²°ì±… ì œì‹œí•˜ë‹¤ê°€', 'í•´ê²°ì±… ì œì‹œí•˜ë‹¤ê°€ ë˜'];
            const noSolutionWords = ['í•´ê²° ëª»í•¨', 'í•´ê²° ëª»í•˜ë‹¤', 'í•´ê²° ëª»í•˜ë‹¤ê°€', 'í•´ê²° ëª»í•˜ë‹¤ê°€ ë˜', 'í•´ê²° ëª»í•˜ë‹¤ê°€ ë˜ ë˜'];

            const solutionScore = solutionWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);
            const noSolutionScore = noSolutionWords.reduce((sum, word) => sum + (text.includes(word) ? 1 : 0), 0);

            return Math.min(solutionScore - noSolutionScore, 5);
        }

        // ë³µì¡ë„ ë¶„ì„
        function analyzeComplexity(text) {
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            const avgLength = sentences.reduce((sum, s) => sum + s.length, 0) / sentences.length;
            return Math.min(avgLength / 20, 5);
        }

        // ìƒ‰ìƒ ìƒì„±
        function getColorForIndex(index) {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            return colors[index % colors.length];
        }

        // íƒœê·¸ë¥¼ í…ìŠ¤íŠ¸ì— í•˜ì´ë¼ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (ë‰˜ì•™ìŠ¤ ê¸°ë°˜)
        function highlightTagsInText(text, tags) {
            if (!text || !tags) return text;
            
            let highlightedText = text;
            
            // íƒœê·¸ë³„ ìƒ‰ìƒ ì •ì˜
            const tagColors = {
                'ê°ì •_ë°©í–¥': '#e3f2fd',      // íŒŒë€ìƒ‰
                'ê°ì •_ê°•ë„': '#e3f2fd',      // íŒŒë€ìƒ‰
                'í–‰ë™_ì„±í–¥': '#e8f5e8',      // ì´ˆë¡ìƒ‰
                'ê´€ê³„_ì§€í–¥ì„±': '#fff3e0',    // ì£¼í™©ìƒ‰
                'í‘œí˜„_ìŠ¤íƒ€ì¼': '#fce4ec'     // ë¶„í™ìƒ‰
            };
            
            // ê° íƒœê·¸ì— ëŒ€í•´ ì˜ë¯¸ì  í•˜ì´ë¼ì´íŠ¸ ìˆ˜í–‰
            Object.entries(tags).forEach(([tagKey, tagValue]) => {
                if (tagValue && typeof tagValue === 'string') {
                    const color = tagColors[tagKey] || '#f0f0f0';
                    
                    // 1. ì •í™•í•œ íƒœê·¸ ê°’ ë§¤ì¹­
                    if (highlightedText.includes(tagValue)) {
                        const highlightedValue = `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 4px; font-weight: bold; color: #333; border: 1px solid ${color};" title="íƒœê·¸: ${tagKey}"><strong>${tagValue}</strong></span>`;
                        highlightedText = highlightedText.replace(new RegExp(escapeRegExp(tagValue), 'g'), highlightedValue);
                    }
                    
                    // 2. ì˜ë¯¸ì  í‚¤ì›Œë“œ ë§¤ì¹­ (ë‰˜ì•™ìŠ¤ ê¸°ë°˜)
                    const semanticKeywords = getSemanticKeywords(tagKey, tagValue);
                    semanticKeywords.forEach(keyword => {
                        if (highlightedText.includes(keyword) && !highlightedText.includes(`<span style="background-color: ${color}`)) {
                            const highlightedKeyword = `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 4px; font-weight: bold; color: #333; border: 1px solid ${color}; opacity: 0.8;" title="ì˜ë¯¸ì  íƒœê·¸: ${tagKey}"><strong>${keyword}</strong></span>`;
                            highlightedText = highlightedText.replace(new RegExp(escapeRegExp(keyword), 'g'), highlightedKeyword);
                        }
                    });
                    
                    // 3. ë¬¸ë§¥ì  í•˜ì´ë¼ì´íŠ¸ (ë¬¸ì¥ì˜ ì˜ë¯¸ íŒŒì•…)
                    const contextualPhrases = findContextualPhrases(text, tagKey, tagValue);
                    contextualPhrases.forEach(phrase => {
                        if (!highlightedText.includes(`<span style="background-color: ${color}`)) {
                            const highlightedPhrase = `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 4px; font-weight: bold; color: #333; border: 1px solid ${color}; opacity: 0.6;" title="ë¬¸ë§¥ì  íƒœê·¸: ${tagKey}"><strong>${phrase}</strong></span>`;
                            highlightedText = highlightedText.replace(new RegExp(escapeRegExp(phrase), 'g'), highlightedPhrase);
                        }
                    });
                }
            });
            
            return highlightedText;
        }

        // ë‰˜ì•™ìŠ¤ ê¸°ë°˜ ì˜ë¯¸ì  í‚¤ì›Œë“œ ìƒì„±
        function getSemanticKeywords(tagKey, tagValue) {
            const semanticMap = {
                // ê°ì • ê´€ë ¨ íƒœê·¸ë“¤
                'emotion': ['ê°ì •', 'ê¸°ë¶„', 'ëŠë‚Œ', 'ë§ˆìŒ', 'ì‹¬ë¦¬', 'ì •ì„œ', 'í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±', 'ì¢‹ìŒ', 'ë‚˜ì¨', 'ë³´í†µ', 'í‰ì˜¨', 'í¥ë¶„', 'ì°¨ë¶„'],
                'sentiment': ['ê°ì •', 'ê¸°ë¶„', 'ëŠë‚Œ', 'ë§ˆìŒ', 'ì‹¬ë¦¬', 'ì •ì„œ', 'í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±', 'ì¢‹ìŒ', 'ë‚˜ì¨', 'ë³´í†µ', 'í‰ì˜¨', 'í¥ë¶„', 'ì°¨ë¶„'],
                'mood': ['ê°ì •', 'ê¸°ë¶„', 'ëŠë‚Œ', 'ë§ˆìŒ', 'ì‹¬ë¦¬', 'ì •ì„œ', 'í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±', 'ì¢‹ìŒ', 'ë‚˜ì¨', 'ë³´í†µ', 'í‰ì˜¨', 'í¥ë¶„', 'ì°¨ë¶„'],
                'feeling': ['ê°ì •', 'ê¸°ë¶„', 'ëŠë‚Œ', 'ë§ˆìŒ', 'ì‹¬ë¦¬', 'ì •ì„œ', 'í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±', 'ì¢‹ìŒ', 'ë‚˜ì¨', 'ë³´í†µ', 'í‰ì˜¨', 'í¥ë¶„', 'ì°¨ë¶„'],
                
                // í–‰ë™ ê´€ë ¨ íƒœê·¸ë“¤
                'behavior': ['í–‰ë™', 'í–‰ìœ„', 'í™œë™', 'ì›€ì§ì„', 'ë°˜ì‘', 'ëŒ€ì‘', 'ì‹œë„', 'ë…¸ë ¥', 'ê³„íš', 'ì‹¤í–‰', 'í•´ê²°', 'ë„ì „', 'í¬ê¸°', 'ì§€ì†', 'ë³€í™”', 'ê°œì„ ', 'ë°œì „', 'ì„±ì¥', 'í•™ìŠµ', 'ì ìš©'],
                'action': ['í–‰ë™', 'í–‰ìœ„', 'í™œë™', 'ì›€ì§ì„', 'ë°˜ì‘', 'ëŒ€ì‘', 'ì‹œë„', 'ë…¸ë ¥', 'ê³„íš', 'ì‹¤í–‰', 'í•´ê²°', 'ë„ì „', 'í¬ê¸°', 'ì§€ì†', 'ë³€í™”', 'ê°œì„ ', 'ë°œì „', 'ì„±ì¥', 'í•™ìŠµ', 'ì ìš©'],
                'response': ['í–‰ë™', 'í–‰ìœ„', 'í™œë™', 'ì›€ì§ì„', 'ë°˜ì‘', 'ëŒ€ì‘', 'ì‹œë„', 'ë…¸ë ¥', 'ê³„íš', 'ì‹¤í–‰', 'í•´ê²°', 'ë„ì „', 'í¬ê¸°', 'ì§€ì†', 'ë³€í™”', 'ê°œì„ ', 'ë°œì „', 'ì„±ì¥', 'í•™ìŠµ', 'ì ìš©'],
                'reaction': ['í–‰ë™', 'í–‰ìœ„', 'í™œë™', 'ì›€ì§ì„', 'ë°˜ì‘', 'ëŒ€ì‘', 'ì‹œë„', 'ë…¸ë ¥', 'ê³„íš', 'ì‹¤í–‰', 'í•´ê²°', 'ë„ì „', 'í¬ê¸°', 'ì§€ì†', 'ë³€í™”', 'ê°œì„ ', 'ë°œì „', 'ì„±ì¥', 'í•™ìŠµ', 'ì ìš©'],
                
                // ê´€ê³„ ê´€ë ¨ íƒœê·¸ë“¤
                'relationship': ['ê´€ê³„', 'ì—°ê²°', 'ì†Œí†µ', 'êµë¥˜', 'ìƒí˜¸ì‘ìš©', 'í˜‘ë ¥', 'ë„ì›€', 'ì§€ì›', 'ì´í•´', 'ê³µê°', 'ë°°ë ¤', 'ì¡´ì¤‘', 'ì‹ ë¢°', 'ì˜ì¡´', 'ë…ë¦½', 'í˜‘ë ¥', 'ê²½ìŸ', 'ê°ˆë“±', 'í™”í•´', 'ì¹œë°€'],
                'interaction': ['ê´€ê³„', 'ì—°ê²°', 'ì†Œí†µ', 'êµë¥˜', 'ìƒí˜¸ì‘ìš©', 'í˜‘ë ¥', 'ë„ì›€', 'ì§€ì›', 'ì´í•´', 'ê³µê°', 'ë°°ë ¤', 'ì¡´ì¤‘', 'ì‹ ë¢°', 'ì˜ì¡´', 'ë…ë¦½', 'í˜‘ë ¥', 'ê²½ìŸ', 'ê°ˆë“±', 'í™”í•´', 'ì¹œë°€'],
                'communication': ['ê´€ê³„', 'ì—°ê²°', 'ì†Œí†µ', 'êµë¥˜', 'ìƒí˜¸ì‘ìš©', 'í˜‘ë ¥', 'ë„ì›€', 'ì§€ì›', 'ì´í•´', 'ê³µê°', 'ë°°ë ¤', 'ì¡´ì¤‘', 'ì‹ ë¢°', 'ì˜ì¡´', 'ë…ë¦½', 'í˜‘ë ¥', 'ê²½ìŸ', 'ê°ˆë“±', 'í™”í•´', 'ì¹œë°€'],
                
                // í‘œí˜„ ê´€ë ¨ íƒœê·¸ë“¤
                'expression': ['í‘œí˜„', 'ì–¸ì–´', 'ë§', 'ê¸€', 'ì „ë‹¬', 'ì„¤ëª…', 'êµ¬ì²´ì ', 'ìƒì„¸', 'ê°„ê²°', 'ì§ì„¤', 'ìš°íšŒ', 'ê°ì •ì ', 'ì´ì„±ì ', 'ë…¼ë¦¬ì ', 'ì§ê´€ì ', 'ì°½ì˜ì ', 'ì²´ê³„ì ', 'ë¬´ì‘ìœ„', 'ì •ëˆëœ', 'ì‚°ë§Œí•œ'],
                'language': ['í‘œí˜„', 'ì–¸ì–´', 'ë§', 'ê¸€', 'ì „ë‹¬', 'ì„¤ëª…', 'êµ¬ì²´ì ', 'ìƒì„¸', 'ê°„ê²°', 'ì§ì„¤', 'ìš°íšŒ', 'ê°ì •ì ', 'ì´ì„±ì ', 'ë…¼ë¦¬ì ', 'ì§ê´€ì ', 'ì°½ì˜ì ', 'ì²´ê³„ì ', 'ë¬´ì‘ìœ„', 'ì •ëˆëœ', 'ì‚°ë§Œí•œ'],
                'style': ['í‘œí˜„', 'ì–¸ì–´', 'ë§', 'ê¸€', 'ì „ë‹¬', 'ì„¤ëª…', 'êµ¬ì²´ì ', 'ìƒì„¸', 'ê°„ê²°', 'ì§ì„¤', 'ìš°íšŒ', 'ê°ì •ì ', 'ì´ì„±ì ', 'ë…¼ë¦¬ì ', 'ì§ê´€ì ', 'ì°½ì˜ì ', 'ì²´ê³„ì ', 'ë¬´ì‘ìœ„', 'ì •ëˆëœ', 'ì‚°ë§Œí•œ'],
                
                // í•œêµ­ì–´ íƒœê·¸ë“¤
                'ê°ì •': ['ê°ì •', 'ê¸°ë¶„', 'ëŠë‚Œ', 'ë§ˆìŒ', 'ì‹¬ë¦¬', 'ì •ì„œ', 'í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±', 'ì¢‹ìŒ', 'ë‚˜ì¨', 'ë³´í†µ', 'í‰ì˜¨', 'í¥ë¶„', 'ì°¨ë¶„'],
                'í–‰ë™': ['í–‰ë™', 'í–‰ìœ„', 'í™œë™', 'ì›€ì§ì„', 'ë°˜ì‘', 'ëŒ€ì‘', 'ì‹œë„', 'ë…¸ë ¥', 'ê³„íš', 'ì‹¤í–‰', 'í•´ê²°', 'ë„ì „', 'í¬ê¸°', 'ì§€ì†', 'ë³€í™”', 'ê°œì„ ', 'ë°œì „', 'ì„±ì¥', 'í•™ìŠµ', 'ì ìš©'],
                'ê´€ê³„': ['ê´€ê³„', 'ì—°ê²°', 'ì†Œí†µ', 'êµë¥˜', 'ìƒí˜¸ì‘ìš©', 'í˜‘ë ¥', 'ë„ì›€', 'ì§€ì›', 'ì´í•´', 'ê³µê°', 'ë°°ë ¤', 'ì¡´ì¤‘', 'ì‹ ë¢°', 'ì˜ì¡´', 'ë…ë¦½', 'í˜‘ë ¥', 'ê²½ìŸ', 'ê°ˆë“±', 'í™”í•´', 'ì¹œë°€'],
                'í‘œí˜„': ['í‘œí˜„', 'ì–¸ì–´', 'ë§', 'ê¸€', 'ì „ë‹¬', 'ì„¤ëª…', 'êµ¬ì²´ì ', 'ìƒì„¸', 'ê°„ê²°', 'ì§ì„¤', 'ìš°íšŒ', 'ê°ì •ì ', 'ì´ì„±ì ', 'ë…¼ë¦¬ì ', 'ì§ê´€ì ', 'ì°½ì˜ì ', 'ì²´ê³„ì ', 'ë¬´ì‘ìœ„', 'ì •ëˆëœ', 'ì‚°ë§Œí•œ'],
                'ì„±í–¥': ['ì„±í–¥', 'ê²½í–¥', 'íŠ¹ì„±', 'íŠ¹ì§•', 'ì„±ê²©', 'ì„±ì§ˆ', 'ì ê·¹ì ', 'ì†Œê·¹ì ', 'ì£¼ë„ì ', 'ìˆ˜ë™ì ', 'ì§ì ‘ì ', 'ê°„ì ‘ì ', 'ê°œë°©ì ', 'íì‡„ì ', 'ìœ ì—°í•œ', 'ê²½ì§ëœ'],
                'ë°©í–¥': ['ë°©í–¥', 'ì§€í–¥', 'ëª©í‘œ', 'ì˜ë„', 'ì˜í–¥', 'ê³„íš', 'í–¥ìƒ', 'ë°œì „', 'ì„±ì¥', 'ì§„ë³´', 'í‡´ë³´', 'ì •ì²´', 'ë³€í™”', 'ì•ˆì •', 'í˜ì‹ ', 'ë³´ìˆ˜'],
                'ê°•ë„': ['ê°•ë„', 'ì •ë„', 'ìˆ˜ì¤€', 'í¬ê¸°', 'ì–‘', 'ì •ëŸ‰', 'ê°•í•¨', 'ì•½í•¨', 'ë†’ìŒ', 'ë‚®ìŒ', 'ì‹¬í•¨', 'ëœí•¨', 'ë§ìŒ', 'ì ìŒ', 'ê·¹ë‹¨ì ', 'ë³´í†µ']
            };
            
            // íƒœê·¸ í‚¤ì—ì„œ ì˜ë¯¸ ì¶”ì¶œ
            const tagMeaning = extractTagMeaning(tagKey);
            const baseKeywords = semanticMap[tagMeaning] || [];
            
            // íƒœê·¸ ê°’ì—ì„œë„ í‚¤ì›Œë“œ ì¶”ì¶œ
            const valueKeywords = extractValueKeywords(tagValue);
            
            return [...new Set([...baseKeywords, ...valueKeywords])];
        }

        // íƒœê·¸ í‚¤ì—ì„œ ì˜ë¯¸ ì¶”ì¶œ
        function extractTagMeaning(tagKey) {
            const lowerTag = tagKey.toLowerCase();
            
            // ì˜ì–´ íƒœê·¸ ì²˜ë¦¬
            if (lowerTag.includes('emotion') || lowerTag.includes('sentiment') || lowerTag.includes('mood') || lowerTag.includes('feeling')) {
                return 'emotion';
            }
            if (lowerTag.includes('behavior') || lowerTag.includes('action') || lowerTag.includes('response') || lowerTag.includes('reaction')) {
                return 'behavior';
            }
            if (lowerTag.includes('relationship') || lowerTag.includes('interaction') || lowerTag.includes('communication')) {
                return 'relationship';
            }
            if (lowerTag.includes('expression') || lowerTag.includes('language') || lowerTag.includes('style')) {
                return 'expression';
            }
            
            // í•œêµ­ì–´ íƒœê·¸ ì²˜ë¦¬
            if (lowerTag.includes('ê°ì •') || lowerTag.includes('ê¸°ë¶„') || lowerTag.includes('ëŠë‚Œ')) {
                return 'ê°ì •';
            }
            if (lowerTag.includes('í–‰ë™') || lowerTag.includes('í™œë™') || lowerTag.includes('ë°˜ì‘')) {
                return 'í–‰ë™';
            }
            if (lowerTag.includes('ê´€ê³„') || lowerTag.includes('ì†Œí†µ') || lowerTag.includes('í˜‘ë ¥')) {
                return 'ê´€ê³„';
            }
            if (lowerTag.includes('í‘œí˜„') || lowerTag.includes('ì–¸ì–´') || lowerTag.includes('ìŠ¤íƒ€ì¼')) {
                return 'í‘œí˜„';
            }
            if (lowerTag.includes('ì„±í–¥') || lowerTag.includes('ê²½í–¥') || lowerTag.includes('íŠ¹ì„±')) {
                return 'ì„±í–¥';
            }
            if (lowerTag.includes('ë°©í–¥') || lowerTag.includes('ì§€í–¥') || lowerTag.includes('ëª©í‘œ')) {
                return 'ë°©í–¥';
            }
            if (lowerTag.includes('ê°•ë„') || lowerTag.includes('ì •ë„') || lowerTag.includes('ìˆ˜ì¤€')) {
                return 'ê°•ë„';
            }
            
            return 'general';
        }

        // íƒœê·¸ ê°’ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
        function extractValueKeywords(tagValue) {
            const keywords = [];
            const lowerValue = tagValue.toLowerCase();
            
            // ê°ì • ê´€ë ¨ í‚¤ì›Œë“œ
            if (lowerValue.includes('ê¸ì •') || lowerValue.includes('positive') || lowerValue.includes('ì¢‹ìŒ') || lowerValue.includes('ë§Œì¡±')) {
                keywords.push('ê¸ì •', 'ì¢‹ìŒ', 'ë§Œì¡±', 'í–‰ë³µ', 'ê¸°ì¨', 'ì¦ê±°ì›€', 'í¬ë§', 'ê°ì‚¬', 'ê°ë™', 'ì„¤ë ˜');
            }
            if (lowerValue.includes('ë¶€ì •') || lowerValue.includes('negative') || lowerValue.includes('ë‚˜ì¨') || lowerValue.includes('ë¶ˆë§Œ')) {
                keywords.push('ë¶€ì •', 'ë‚˜ì¨', 'ë¶ˆë§Œ', 'ìŠ¬í””', 'í™”ë‚¨', 'ì§œì¦', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ê±±ì •', 'ë‘ë ¤ì›€');
            }
            if (lowerValue.includes('ì¤‘ë¦½') || lowerValue.includes('neutral') || lowerValue.includes('ë³´í†µ') || lowerValue.includes('ì¼ë°˜')) {
                keywords.push('ì¤‘ë¦½', 'ë³´í†µ', 'ì¼ë°˜', 'í‰ì˜¨', 'ì°¨ë¶„', 'ì•ˆì •', 'ì¡°ìš©', 'í‰ë²”', 'ë³´í¸ì ');
            }
            
            // ê°•ë„ ê´€ë ¨ í‚¤ì›Œë“œ
            if (lowerValue.includes('ê°•í•¨') || lowerValue.includes('ë†’ìŒ') || lowerValue.includes('strong') || lowerValue.includes('ì‹¬í•¨')) {
                keywords.push('ê°•í•¨', 'ë†’ìŒ', 'ì‹¬í•¨', 'ê·¹ë‹¨ì ', 'ë§ìŒ', 'ì¶©ë¶„', 'ì™„ì „', 'ì ˆëŒ€ì ', 'ê·¹ë„');
            }
            if (lowerValue.includes('ì•½í•¨') || lowerValue.includes('ë‚®ìŒ') || lowerValue.includes('weak') || lowerValue.includes('ëœí•¨')) {
                keywords.push('ì•½í•¨', 'ë‚®ìŒ', 'ëœí•¨', 'ì ìŒ', 'ë¶€ì¡±', 'ë¯¸ë¯¸', 'í¬ë°•', 'í¬ë¯¸', 'ì—°ì•½');
            }
            
            // í–‰ë™ ê´€ë ¨ í‚¤ì›Œë“œ
            if (lowerValue.includes('ì ê·¹') || lowerValue.includes('active') || lowerValue.includes('ì£¼ë„') || lowerValue.includes('ì§ì ‘')) {
                keywords.push('ì ê·¹', 'ì£¼ë„', 'ì§ì ‘', 'ì ê·¹ì ', 'ì£¼ë„ì ', 'ì§ì ‘ì ', 'ì ê·¹ì ìœ¼ë¡œ', 'ì£¼ë„ì ìœ¼ë¡œ', 'ì§ì ‘ì ìœ¼ë¡œ');
            }
            if (lowerValue.includes('ì†Œê·¹') || lowerValue.includes('passive') || lowerValue.includes('ìˆ˜ë™') || lowerValue.includes('ê°„ì ‘')) {
                keywords.push('ì†Œê·¹', 'ìˆ˜ë™', 'ê°„ì ‘', 'ì†Œê·¹ì ', 'ìˆ˜ë™ì ', 'ê°„ì ‘ì ', 'ì†Œê·¹ì ìœ¼ë¡œ', 'ìˆ˜ë™ì ìœ¼ë¡œ', 'ê°„ì ‘ì ìœ¼ë¡œ');
            }
            
            // ê´€ê³„ ê´€ë ¨ í‚¤ì›Œë“œ
            if (lowerValue.includes('í˜‘ë ¥') || lowerValue.includes('cooperative') || lowerValue.includes('ë„ì›€')) {
                keywords.push('í˜‘ë ¥', 'ë„ì›€', 'ì§€ì›', 'ë°°ë ¤', 'ì´í•´', 'ê³µê°', 'í˜‘ë ¥ì ', 'ë„ì›€ì´ ë˜ëŠ”', 'ì§€ì§€í•˜ëŠ”');
            }
            if (lowerValue.includes('ê²½ìŸ') || lowerValue.includes('competitive') || lowerValue.includes('ê°ˆë“±')) {
                keywords.push('ê²½ìŸ', 'ê°ˆë“±', 'ëŒ€ë¦½', 'ì¶©ëŒ', 'ê²½ìŸì ', 'ê°ˆë“±ì ', 'ëŒ€ë¦½ì ', 'ì¶©ëŒì ');
            }
            
            // í‘œí˜„ ê´€ë ¨ í‚¤ì›Œë“œ
            if (lowerValue.includes('ì§ì„¤') || lowerValue.includes('direct') || lowerValue.includes('êµ¬ì²´ì ')) {
                keywords.push('ì§ì„¤', 'êµ¬ì²´ì ', 'ìƒì„¸', 'ëª…í™•', 'ì§ì„¤ì ', 'êµ¬ì²´ì ìœ¼ë¡œ', 'ìƒì„¸í•˜ê²Œ', 'ëª…í™•í•˜ê²Œ');
            }
            if (lowerValue.includes('ìš°íšŒ') || lowerValue.includes('indirect') || lowerValue.includes('ê°„ê²°')) {
                keywords.push('ìš°íšŒ', 'ê°„ê²°', 'ê°„ë‹¨', 'ìš”ì•½', 'ìš°íšŒì ', 'ê°„ê²°í•˜ê²Œ', 'ê°„ë‹¨í•˜ê²Œ', 'ìš”ì•½ì ìœ¼ë¡œ');
            }
            
            return keywords;
        }

        // ë¬¸ë§¥ì  êµ¬ë¬¸ ì°¾ê¸° (ë‰˜ì•™ìŠ¤ ê¸°ë°˜)
        function findContextualPhrases(text, tagKey, tagValue) {
            const matches = [];
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
            
            sentences.forEach(sentence => {
                // íƒœê·¸ì˜ ì˜ë¯¸ì™€ ê´€ë ¨ëœ ë¬¸ì¥ ì°¾ê¸°
                if (isContextuallyRelevant(sentence, tagKey, tagValue)) {
                    // ë¬¸ì¥ì—ì„œ í•µì‹¬ ë¶€ë¶„ ì¶”ì¶œ (ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ)
                    const words = sentence.trim().split(/\s+/);
                    if (words.length > 3) {
                        // ë¬¸ì¥ì˜ ì¤‘ê°„ ë¶€ë¶„ì„ ì„ íƒ (ì‹œì‘ê³¼ ëì€ ì œì™¸)
                        const start = Math.floor(words.length * 0.2);
                        const end = Math.floor(words.length * 0.8);
                        const keyPart = words.slice(start, end).join(' ');
                        if (keyPart.length > 5) {
                            matches.push(keyPart);
                        }
                    } else {
                        matches.push(sentence.trim());
                    }
                }
            });
            
            return matches.slice(0, 2); // ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ë°˜í™˜
        }

        // ë¬¸ë§¥ì  ê´€ë ¨ì„± íŒë‹¨
        function isContextuallyRelevant(sentence, tagKey, tagValue) {
            const lowerSentence = sentence.toLowerCase();
            const lowerTagKey = tagKey.toLowerCase();
            const lowerTagValue = tagValue.toLowerCase();
            
            // íƒœê·¸ í‚¤ì™€ ê´€ë ¨ëœ ë‹¨ì–´ë“¤ì´ ë¬¸ì¥ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const relevantWords = {
                'emotion': ['ê°ì •', 'ê¸°ë¶„', 'ëŠë‚Œ', 'ë§ˆìŒ', 'ì‹¬ë¦¬', 'ì •ì„œ', 'í–‰ë³µ', 'ìŠ¬í””', 'í™”ë‚¨', 'ê¸°ì¨', 'ìš°ìš¸', 'ë¶ˆì•ˆ', 'ì§œì¦', 'ë§Œì¡±', 'ì¢‹ìŒ', 'ë‚˜ì¨', 'ë³´í†µ', 'í‰ì˜¨', 'í¥ë¶„', 'ì°¨ë¶„', 'ê±±ì •', 'ë‘ë ¤ì›€', 'ì„¤ë ˜', 'ê°ë™', 'ê°ì‚¬', 'í¬ë§', 'ì¦ê±°ì›€'],
                'behavior': ['í–‰ë™', 'í–‰ìœ„', 'í™œë™', 'ì›€ì§ì„', 'ë°˜ì‘', 'ëŒ€ì‘', 'ì‹œë„', 'ë…¸ë ¥', 'ê³„íš', 'ì‹¤í–‰', 'í•´ê²°', 'ë„ì „', 'í¬ê¸°', 'ì§€ì†', 'ë³€í™”', 'ê°œì„ ', 'ë°œì „', 'ì„±ì¥', 'í•™ìŠµ', 'ì ìš©', 'ì‹œì‘', 'ë', 'ê³„ì†', 'ë©ˆì¶¤', 'ë°”ê¿ˆ', 'ê³ ì¹˜ë‹¤', 'ë§Œë“¤ë‹¤', 'í•˜ë‹¤'],
                'relationship': ['ê´€ê³„', 'ì—°ê²°', 'ì†Œí†µ', 'êµë¥˜', 'ìƒí˜¸ì‘ìš©', 'í˜‘ë ¥', 'ë„ì›€', 'ì§€ì›', 'ì´í•´', 'ê³µê°', 'ë°°ë ¤', 'ì¡´ì¤‘', 'ì‹ ë¢°', 'ì˜ì¡´', 'ë…ë¦½', 'ê²½ìŸ', 'ê°ˆë“±', 'í™”í•´', 'ì¹œë°€', 'ì¹œêµ¬', 'ê°€ì¡±', 'ë™ë£Œ', 'ì´ì›ƒ', 'ì‚¬ëŒ', 'ëˆ„êµ°ê°€', 'í•¨ê»˜', 'í˜¼ì'],
                'expression': ['í‘œí˜„', 'ì–¸ì–´', 'ë§', 'ê¸€', 'ì „ë‹¬', 'ì„¤ëª…', 'êµ¬ì²´ì ', 'ìƒì„¸', 'ê°„ê²°', 'ì§ì„¤', 'ìš°íšŒ', 'ê°ì •ì ', 'ì´ì„±ì ', 'ë…¼ë¦¬ì ', 'ì§ê´€ì ', 'ì°½ì˜ì ', 'ì²´ê³„ì ', 'ë¬´ì‘ìœ„', 'ì •ëˆëœ', 'ì‚°ë§Œí•œ', 'ì´ì•¼ê¸°', 'ì„¤ëª…', 'ì „ë‹¬', 'ì•Œë¦¬ë‹¤', 'ë§í•˜ë‹¤', 'ì“°ë‹¤']
            };
            
            // íƒœê·¸ í‚¤ì˜ ì˜ë¯¸ íŒŒì•…
            let tagCategory = 'general';
            for (const [category, words] of Object.entries(relevantWords)) {
                if (words.some(word => lowerTagKey.includes(word) || lowerTagValue.includes(word))) {
                    tagCategory = category;
                    break;
                }
            }
            
            // ë¬¸ì¥ì´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì™€ ê´€ë ¨ìˆëŠ”ì§€ í™•ì¸
            const categoryWords = relevantWords[tagCategory] || [];
            return categoryWords.some(word => lowerSentence.includes(word));
        }

        // ì •ê·œì‹ íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // íˆíŠ¸ë§µ ìƒì„±
        /* function generateHeatmap() {
            const container = document.getElementById('heatmapContent');
            
            if (!currentExperiment || !currentExperiment.prefs) {
                container.innerHTML = '<div class="info-box">ì‹¤í—˜ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            // ì‹¤ì œ ë°ì´í„°ë¡œ íˆíŠ¸ë§µ ìƒì„±
            const heatmapData = generateHeatmapDataFromExperiment();
            
            if (heatmapData.length === 0) {
                container.innerHTML = '<div class="info-box">íˆíŠ¸ë§µ ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '<table class="heatmap-table">';
            html += '<thead><tr><th>í˜ë¥´ì†Œë‚˜</th>';
            
            // ì˜ë¯¸ ì¶• í—¤ë”
            const dimensions = getAvailableDimensions();
            dimensions.forEach(dim => {
                html += `<th>${dim}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // ë°ì´í„° í–‰
            heatmapData.forEach(row => {
                html += `<tr><td><strong>${row.personality}</strong></td>`;
                row.values.forEach(value => {
                    const intensity = Math.min(5, Math.max(0, value));
                    const color = getHeatmapColor(intensity);
                    html += `<td><div class="heatmap-cell" style="background-color: ${color}">${intensity.toFixed(1)}</div></td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } */

        // ì‹¤í—˜ ë°ì´í„°ì—ì„œ íˆíŠ¸ë§µ ë°ì´í„° ìƒì„±
        function generateHeatmapDataFromExperiment() {
            const data = [];
            const dimensions = getAvailableDimensions();
            
            // ê° í˜ë¥´ì†Œë‚˜ë³„ë¡œ ë°ì´í„° ìˆ˜ì§‘
            const personalities = [];
            currentExperiment.prompts.forEach(prompt => {
                if (prompt.personality && !personalities.includes(prompt.personality)) {
                    personalities.push(prompt.personality);
                }
            });
            
            personalities.forEach(personality => {
                const values = [];
                dimensions.forEach(dimension => {
                    const value = analyzeResponseValue(personality, dimension);
                    values.push(value);
                });
                
                data.push({
                    personality: personality,
                    values: values
                });
            });
            
            return data;
        }

        // ì‚¬ìš© ê°€ëŠ¥í•œ ì˜ë¯¸ ì¶• ëª©ë¡
        function getAvailableDimensions() {
            return [
                'emotional_intensity',
                'valence',
                'expression_type',
                'agency',
                'extroversion',
                'solution_offered',
                'response_length',
                'complexity'
            ];
        }

        // ì¶•ë³„ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ìƒì„±
        async function generateSortingList() {
            console.log('ğŸš€ generateSortingList í•¨ìˆ˜ ì‹œì‘');
            
            const container = document.getElementById('sortingListContent');
            console.log('sortingListContent ì»¨í…Œì´ë„ˆ:', container);
            
            if (!container) {
                console.error('âŒ sortingListContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            console.log('currentExperiment:', currentExperiment);
            console.log('currentDimension:', currentDimension);
            
            if (!currentExperiment || !currentDimension) {
                console.log('âŒ í•„ìˆ˜ ë°ì´í„° ëˆ„ë½');
                container.innerHTML = '<div class="info-box">ì‹¤í—˜ê³¼ ì˜ë¯¸ ì¶•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ì°¨íŠ¸ ìƒì„± (ë°±ì—”ë“œ API í˜¸ì¶œ ì—†ì´)
            console.log('ğŸ”„ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ì°¨íŠ¸ ìƒì„± ì‹œì‘');
            const sortingData = generateSortingDataFromExperiment();
            console.log('ìƒì„±ëœ ì •ë ¬ ë°ì´í„°:', sortingData);
            console.log('ì •ë ¬ ë°ì´í„° ê¸¸ì´:', sortingData.length);
            
            if (sortingData.length === 0) {
                console.log('âŒ ì •ë ¬ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ');
                container.innerHTML = '<div class="info-box">ì •ë ¬ ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹¤í—˜ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                return;
            }
            
            // ê°’ì— ë”°ë¼ ì •ë ¬
            sortingData.sort((a, b) => b.value - a.value);
            
            // ë§‰ëŒ€ ì°¨íŠ¸ ìƒì„± (Plotly ì‚¬ìš©)
            const chartData = [{
                x: sortingData.map(item => item.personality),
                y: sortingData.map(item => item.value),
                type: 'bar',
                marker: {
                    color: sortingData.map((item, index) => 
                        index < 3 ? '#FF6384' : '#36A2EB'
                    ),
                    opacity: 0.8
                },
                text: sortingData.map(item => item.value.toFixed(2)),
                textposition: 'auto',
                hovertemplate: '<b>%{x}</b><br>ê°’: %{y:.2f}<extra></extra>'
            }];
            
            const layout = {
                title: `${currentDimension || 'ì˜ë¯¸ ì¶•'} ê¸°ì¤€ ì •ë ¬`,
                xaxis: { title: '' },  // xì¶• ì œëª© ì œê±°
                yaxis: { title: 'ì ìˆ˜' },
                showlegend: false,
                margin: { l: 60, r: 30, t: 60, b: 80 }
            };
            
            // ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì¤€ë¹„
            console.log('ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ì¤‘...');
            let chartContainer = document.getElementById('sortingContent');
            console.log('sortingContent ì»¨í…Œì´ë„ˆ:', chartContainer);
            
            if (!chartContainer) {
                console.log('âš ï¸ sortingContent ìš”ì†Œê°€ ì—†ì–´ ìƒˆë¡œ ìƒì„±');
                // sortingContentê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                chartContainer = document.createElement('div');
                chartContainer.id = 'sortingContent';
                chartContainer.className = 'chart-container';
                chartContainer.style.marginTop = '20px';
                
                // ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ì„¹ì…˜ì— ì¶”ê°€
                const sortingSection = document.querySelector('.visualization-section');
                if (sortingSection) {
                    sortingSection.appendChild(chartContainer);
                    console.log('âœ… sortingContent ì»¨í…Œì´ë„ˆ ìƒˆë¡œ ìƒì„±ë¨');
                } else {
                    console.error('âŒ visualization-sectionì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }
            }
            
            chartContainer.innerHTML = '<div id="sortingChart"></div>';
            console.log('âœ… ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ì¤€ë¹„ ì™„ë£Œ');
            
            // ìƒˆ ì°¨íŠ¸ ìƒì„±
            console.log('Plotly ì°¨íŠ¸ ìƒì„± ì‹œì‘');
            console.log('ì°¨íŠ¸ ë°ì´í„°:', chartData);
            console.log('ì°¨íŠ¸ ë ˆì´ì•„ì›ƒ:', layout);
            
            try {
                Plotly.newPlot('sortingChart', chartData, layout, {responsive: true});
                console.log('âœ… Plotly ì°¨íŠ¸ ìƒì„± ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ Plotly ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
                // ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨ ì‹œ ê°„ë‹¨í•œ HTMLë¡œ ëŒ€ì²´
                chartContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3>${getDimensionDisplayName(currentDimension)} ê¸°ì¤€ ì •ë ¬</h3>
                        <div style="margin-top: 20px;">
                            ${sortingData.map((item, index) => `
                                <div style="margin: 10px 0; padding: 10px; background: ${index < 3 ? '#FF6384' : '#36A2EB'}; color: white; border-radius: 5px;">
                                    ${index + 1}ìœ„: ${item.personality} (${item.value.toFixed(2)})
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                console.log('âœ… HTML ì°¨íŠ¸ë¡œ ëŒ€ì²´ ì™„ë£Œ');
            }
            
            // ì •ë ¬ ë¦¬ìŠ¤íŠ¸ë„ í•¨ê»˜ í‘œì‹œ (ìƒìœ„ 3ê°œë§Œ ë¨¼ì € í‘œì‹œ)
            let html = '<div class="sorting-list" style="margin-top: 20px;">';
            html += `<h4>ğŸ“Š ${getDimensionDisplayName(currentDimension)} ê¸°ì¤€ ìˆœìœ„</h4>`;
            html += '<div class="sorting-items" id="sortingItemsContainer">';
            
            // ìƒìœ„ 3ê°œë§Œ ë¨¼ì € í‘œì‹œ
            const top3Items = sortingData.slice(0, 3);
            top3Items.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? 'top-rank' : '';
                html += `
                    <div class="sorting-item ${rankClass}">
                        <span class="rank">${rank}</span>
                        <span class="personality">${item.personality}</span>
                        <span class="value">${item.value.toFixed(2)}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // 4ìœ„ ì´í•˜ê°€ ìˆëŠ” ê²½ìš° ë”ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
            if (sortingData.length > 3) {
                html += `
                    <div class="show-more-container" style="text-align: center; margin-top: 20px;">
                        <button id="showMoreBtn" class="show-more-btn" onclick="toggleSortingList()">
                            ğŸ“‹ ë”ë³´ê¸° (${sortingData.length - 3}ê°œ ë”)
                        </button>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // ì •ë ¬ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (ë”ë³´ê¸° ê¸°ëŠ¥ìš©)
            window.currentSortingData = sortingData;
            
            // ì¶•ë³„ ì •ë ¬ ì°¨íŠ¸ ìƒì„± ì™„ë£Œ í›„ ë¡œë”© ìƒíƒœ ì œê±°
            const loadingChartContainer = document.querySelector('.chart-container');
            if (loadingChartContainer) {
                loadingChartContainer.classList.remove('loading');
            }
            
            console.log('âœ… ì •ë ¬ ì°¨íŠ¸ ë° ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ');
        }

        // ì‹¤í—˜ ë°ì´í„°ì—ì„œ ì •ë ¬ ë°ì´í„° ìƒì„±
        function generateSortingDataFromExperiment() {
            const data = [];
            console.log('generateSortingDataFromExperiment ì‹œì‘');
            console.log('currentExperiment êµ¬ì¡°:', Object.keys(currentExperiment));
            
            // ì˜¬ë°”ë¥¸ ë°ì´í„° êµ¬ì¡° í™•ì¸
            if (!currentExperiment.history || currentExperiment.history.length === 0) {
                console.error('âŒ currentExperiment.historyê°€ ì—†ìŠµë‹ˆë‹¤');
                return data;
            }
            
            const firstHistory = currentExperiment.history[0];
            console.log('firstHistory êµ¬ì¡°:', Object.keys(firstHistory));
            
            // ê° í˜ë¥´ì†Œë‚˜ë³„ë¡œ ê°’ ê³„ì‚°
            const personalities = [];
            
            // answersì—ì„œ í˜ë¥´ì†Œë‚˜ ì¶”ì¶œ
            if (firstHistory.answers && firstHistory.answers.length > 0) {
                firstHistory.answers.forEach(answer => {
                    if (answer.personality && !personalities.includes(answer.personality)) {
                        personalities.push(answer.personality);
                    }
                });
            }
            
            // promptsì—ì„œë„ í˜ë¥´ì†Œë‚˜ ì¶”ì¶œ (ë°±ì—…)
            if (firstHistory.prompts && firstHistory.prompts.length > 0) {
                firstHistory.prompts.forEach(prompt => {
                    if (prompt.personality && !personalities.includes(prompt.personality)) {
                        personalities.push(prompt.personality);
                    }
                });
            }
            
            console.log('ì°¾ì€ í˜ë¥´ì†Œë‚˜ë“¤:', personalities);
            
            // ë§Œì•½ í˜ë¥´ì†Œë‚˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ë‹¤ë©´ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
            if (personalities.length === 0) {
                console.log('âš ï¸ í˜ë¥´ì†Œë‚˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìƒ˜í”Œ ë°ì´í„° ìƒì„±');
                personalities.push('í˜ë¥´ì†Œë‚˜ A', 'í˜ë¥´ì†Œë‚˜ B', 'í˜ë¥´ì†Œë‚˜ C', 'í˜ë¥´ì†Œë‚˜ D');
            }
            
            personalities.forEach(personality => {
                const value = analyzeResponseValue(personality, currentDimension);
                console.log(`${personality}: ${value}`);
                data.push({
                    personality: personality,
                    value: value
                });
            });
            
            console.log('ìµœì¢… ë°ì´í„°:', data);
            return data;
        }

        // ì˜ë¯¸ ì¶• í‘œì‹œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        function getDimensionDisplayName(dimension) {
            const displayNames = {
                'emotional_intensity': 'ê°ì • ê°•ë„',
                'valence': 'ì •ì„œ ë°©í–¥',
                'expression_type': 'í‘œí˜„ ìŠ¤íƒ€ì¼',
                'agency': 'ìê¸° ì£¼ë„ì„±',
                'extroversion': 'ì™¸í–¥ì„±',
                'solution_offered': 'í•´ê²° ì „ëµ ì œì‹œ',
                'response_length': 'ì‘ë‹µ ê¸¸ì´',
                'complexity': 'ì‘ë‹µ ë³µì¡ë„'
            };
            
            if (dimension.startsWith('temperament_')) {
                const key = dimension.replace('temperament_', '');
                return `ê¸°ì§ˆ: ${key}`;
            } else if (dimension.startsWith('character_')) {
                const key = dimension.replace('character_', '');
                return `ì„±ê²©: ${key}`;
            }
            
            return displayNames[dimension] || dimension;
        }

        // ìƒ˜í”Œ ë ˆì´ë” ì°¨íŠ¸ ë°ì´í„° ìƒì„±
        function generateSampleRadarData() {
            const labels = ['ê°ì • ê°•ë„', 'ì •ì„œ ë°©í–¥', 'ìê¸° ì£¼ë„ì„±', 'ì‚¬íšŒì  ì§€í–¥ì„±', 'ëŒ€ì²˜ ë°©ì‹'];
            
            return [
                {
                    type: 'scatterpolar',
                    mode: 'lines+markers',
                    name: 'í˜ë¥´ì†Œë‚˜ A',
                    r: [4, 3, 5, 2, 4],
                    theta: labels,
                    line: {
                        color: '#8E12D5',
                        width: 3
                    },
                    marker: {
                        color: '#8E12D5',
                        size: 10,
                        symbol: 'circle'
                    },
                    fill: 'toself',
                    fillcolor: '#8E12D540',
                    opacity: 0.6
                },
                {
                    type: 'scatterpolar',
                    mode: 'lines+markers',
                    name: 'í˜ë¥´ì†Œë‚˜ B',
                    r: [2, 4, 3, 5, 3],
                    theta: labels,
                    line: {
                        color: '#6a0dad',
                        width: 3
                    },
                    marker: {
                        color: '#6a0dad',
                        size: 10,
                        symbol: 'circle'
                    },
                    fill: 'toself',
                    fillcolor: '#6a0dad40',
                    opacity: 0.6
                },
                {
                    type: 'scatterpolar',
                    mode: 'lines+markers',
                    name: 'í˜ë¥´ì†Œë‚˜ C',
                    r: [5, 2, 4, 3, 5],
                    theta: labels,
                    line: {
                        color: '#ff6b6b',
                        width: 3
                    },
                    marker: {
                        color: '#ff6b6b',
                        size: 10,
                        symbol: 'circle'
                    },
                    fill: 'toself',
                    fillcolor: '#ff6b6b40',
                    opacity: 0.6
                }
            ];
        }

        // ìƒ˜í”Œ íˆíŠ¸ë§µ ë°ì´í„° ìƒì„±
        function generateSampleHeatmapData() {
            return [
                { question: 'ì§ˆë¬¸ 1', values: [4.2, 3.8, 4.5, 2.1, 3.9] },
                { question: 'ì§ˆë¬¸ 2', values: [3.1, 4.7, 3.2, 4.8, 3.5] },
                { question: 'ì§ˆë¬¸ 3', values: [4.8, 2.9, 4.1, 3.6, 4.3] }
            ];
        }

        // ìƒ˜í”Œ ì •ë ¬ ë°ì´í„° ìƒì„±
        function generateSampleSortingData() {
            return {
                'ê°ì • ê°•ë„ (ë†’ì€ ìˆœ)': [
                    { name: 'í˜ë¥´ì†Œë‚˜ C', score: 4.8 },
                    { name: 'í˜ë¥´ì†Œë‚˜ A', score: 4.2 },
                    { name: 'í˜ë¥´ì†Œë‚˜ B', score: 3.1 }
                ],
                'ìê¸° ì£¼ë„ì„± (ë†’ì€ ìˆœ)': [
                    { name: 'í˜ë¥´ì†Œë‚˜ A', score: 4.5 },
                    { name: 'í˜ë¥´ì†Œë‚˜ C', score: 4.1 },
                    { name: 'í˜ë¥´ì†Œë‚˜ B', score: 3.2 }
                ],
                'ì‚¬íšŒì  ì§€í–¥ì„± (ë†’ì€ ìˆœ)': [
                    { name: 'í˜ë¥´ì†Œë‚˜ B', score: 4.8 },
                    { name: 'í˜ë¥´ì†Œë‚˜ C', score: 3.6 },
                    { name: 'í˜ë¥´ì†Œë‚˜ A', score: 2.1 }
                ]
            };
        }

        // íˆíŠ¸ë§µ ìƒ‰ìƒ ìƒì„±
        function getHeatmapColor(intensity) {
            const normalized = intensity / 5; // 0-5 ë²”ìœ„ë¥¼ 0-1ë¡œ ì •ê·œí™”
            const red = Math.round(255 * (1 - normalized));
            const green = Math.round(255 * normalized);
            const blue = 100;
            return `rgb(${red}, ${green}, ${blue})`;
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function clearVisualizations() {
            console.log('ğŸ§¹ clearVisualizations í˜¸ì¶œë¨ - ëª¨ë“  ì‹œê°í™” ì´ˆê¸°í™”');
            
            // ë ˆì´ë” ì°¨íŠ¸ ì´ˆê¸°í™”
            if (currentRadarChart) {
                Plotly.purge('radarChart');
                currentRadarChart = null;
            }
            
            // íˆíŠ¸ë§µ ì„¹ì…˜ì´ ì£¼ì„ì²˜ë¦¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            // const heatmapContent = document.getElementById('heatmapContent');
            // if (heatmapContent) {
            //     heatmapContent.innerHTML = `
            //     <div class="info-box">
            //         <strong>ğŸ’¡ íˆíŠ¸ë§µ ì‚¬ìš©ë²•:</strong> ì§ˆë¬¸ê³¼ ì˜ë¯¸ ì¶•ì„ ì„ íƒí•œ í›„ ë¶„ì„ì„ ì‹œì‘í•˜ë©´, 
            //         í˜ë¥´ì†Œë‚˜ë³„ ì‘ë‹µì„ ìƒ‰ìƒ ê°•ë„ë¡œ ì‹œê°í™”í•˜ì—¬ ê²½í–¥ì„±ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            //     </div>
            // `;
            // }
            
            // // ì •ë ¬ ì°¨íŠ¸ ì´ˆê¸°í™”
            // document.getElementById('sortingContent').innerHTML = `
            //     <div class="info-box">
            //         <strong>ğŸ’¡ ì •ë ¬ ì°¨íŠ¸ ì‚¬ìš©ë²•:</strong> ì˜ë¯¸ ì¶•ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¶•ì— ë”°ë¼ 
            //         í˜ë¥´ì†Œë‚˜ë“¤ì„ ì •ë ¬í•˜ì—¬ ë§‰ëŒ€ ì°¨íŠ¸ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤. "ìê¸°ì£¼ë„ì„±ì´ ë†’ì€ ìˆœ", "ê°ì • ê°•ë„ê°€ ë‚®ì€ ìˆœ" ë“±ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            //     </div>
            // `;
            
            // // ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
            // document.getElementById('sortingListContent').innerHTML = `
            //     <div class="info-box">
            //         <strong>ğŸ’¡ ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ë²•:</strong> ì˜ë¯¸ ì¶•ì„ ì„ íƒí•˜ë©´ í•´ë‹¹ ì¶•ì— ë”°ë¼ 
            //         í˜ë¥´ì†Œë‚˜ë“¤ì„ ìˆœìœ„ë³„ë¡œ ì •ë ¬í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤. "ìê¸°ì£¼ë„ì„±ì´ ë†’ì€ ìˆœ", "ê°ì • ê°•ë„ê°€ ë‚®ì€ ìˆœ" ë“±ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            //     </div>
            // `;
            
            // ì •ë ¬ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const sortingListSection = document.getElementById('sortingListSection');
            if (sortingListSection) {
                sortingListSection.style.display = 'none';
            }
            
            // êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
            const structuredAnalysisContent = document.getElementById('structuredAnalysisContent');
            if (structuredAnalysisContent) {
                structuredAnalysisContent.style.display = 'none';
            }
            
            // Diff ì„¹ì…˜ ì´ˆê¸°í™”
            const diffContent = document.getElementById('diffContent');
            if (diffContent) {
                diffContent.style.display = 'none';
            }
            
            // Diff ì„¹ì…˜ì˜ í˜ë¥´ì†Œë‚˜ ì„ íƒ ì´ˆê¸°í™”
            const personaA = document.getElementById('personaA');
            const personaB = document.getElementById('personaB');
            if (personaA) personaA.value = '';
            if (personaB) personaB.value = '';
            
            // ì „ì—­ ë³€ìˆ˜ë“¤ ì´ˆê¸°í™”
            window.currentSortingData = null;
            
            console.log('âœ… ëª¨ë“  ì‹œê°í™” ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // í˜ë¥´ì†Œë‚˜ ëª©ë¡ ë¡œë“œ (Diffìš©)
        function loadPersonasForDiff() {
            const personaA = document.getElementById('personaA');
            const personaB = document.getElementById('personaB');
            
            // DOM ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (!personaA || !personaB) {
                console.log('âŒ í˜ë¥´ì†Œë‚˜ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±°
            personaA.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            personaB.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            
            if (currentExperiment && currentExperiment.history && currentExperiment.history.length > 0) {
                // ë‹¤ì–‘í•œ ë°ì´í„° êµ¬ì¡°ì—ì„œ í˜ë¥´ì†Œë‚˜ ì¶”ì¶œ
                let personas = [];
                
                console.log('ì‹¤í—˜ ë°ì´í„° êµ¬ì¡° ë¶„ì„:', currentExperiment.history[0]);
                
                if (currentExperiment.history[0].prompts) {
                    console.log('Prompts êµ¬ì¡° ë°œê²¬');
                    personas = [...new Set(currentExperiment.history[0].prompts.map(p => {
                        const personality = p.personality || p.persona || p.name || 'Unknown';
                        console.log('Prompt í˜ë¥´ì†Œë‚˜:', { 
                            personality, 
                            has_answer: !!p.answer, 
                            has_qa: !!p.qa,
                            has_response: !!p.response,
                            has_text: !!p.text
                        });
                        return personality;
                    }))];
                } else if (currentExperiment.history[0].answers) {
                    console.log('Answers êµ¬ì¡° ë°œê²¬');
                    personas = [...new Set(currentExperiment.history[0].answers.map(a => {
                        const personality = a.personality || a.persona || a.name || 'Unknown';
                        console.log('Answer í˜ë¥´ì†Œë‚˜:', { 
                            personality, 
                            has_answer: !!a.answer, 
                            has_qa: !!a.qa,
                            has_response: !!a.response,
                            has_text: !!a.text
                        });
                        return personality;
                    }))];
                } else {
                    console.log('âŒ prompts ë˜ëŠ” answers êµ¬ì¡°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    console.log('ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ë“¤:', Object.keys(currentExperiment.history[0]));
                }
                
                // 'Unknown' ì œê±°
                personas = personas.filter(p => p !== 'Unknown');
                
                console.log('ì¶”ì¶œëœ í˜ë¥´ì†Œë‚˜ ëª©ë¡:', personas);
                
                if (personas.length > 0) {
                    personas.forEach(persona => {
                        // í˜ë¥´ì†Œë‚˜ A ì˜µì…˜ ì¶”ê°€
                        const optA = document.createElement('option');
                        optA.value = persona;
                        optA.textContent = persona;
                        personaA.appendChild(optA);
                        
                        // í˜ë¥´ì†Œë‚˜ B ì˜µì…˜ ì¶”ê°€ (ë³µì‚¬)
                        const optB = document.createElement('option');
                        optB.value = persona;
                        optB.textContent = persona;
                        personaB.appendChild(optB);
                    });
                    
                    console.log('âœ… Diffìš© í˜ë¥´ì†Œë‚˜ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', personas);
                } else {
                    console.log('âš ï¸ í˜ë¥´ì†Œë‚˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                    const diffSection = document.getElementById('diffSection');
                    if (diffSection) {
                        const infoDiv = diffSection.querySelector('.info-box') || document.createElement('div');
                        if (!diffSection.querySelector('.info-box')) {
                            infoDiv.className = 'info-box';
                            infoDiv.style.cssText = 'background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px;';
                            diffSection.insertBefore(infoDiv, diffSection.firstChild);
                        }
                        infoDiv.innerHTML = '<strong>ğŸ’¡ ì•ˆë‚´:</strong> ì„ íƒí•œ ì‹¤í—˜ì— í˜ë¥´ì†Œë‚˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‹¤í—˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                    }
                }
            } else {
                console.log('âŒ currentExperiment ë˜ëŠ” history ë°ì´í„° ì—†ìŒ');
                // ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                const diffSection = document.getElementById('diffSection');
                if (diffSection) {
                    const infoDiv = diffSection.querySelector('.info-box') || document.createElement('div');
                    if (!diffSection.querySelector('.info-box')) {
                        infoDiv.className = 'info-box';
                        infoDiv.style.cssText = 'background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px;';
                        diffSection.insertBefore(infoDiv, diffSection.firstChild);
                    }
                    infoDiv.innerHTML = '<strong>ğŸ’¡ ì•ˆë‚´:</strong> ì‹¤í—˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.';
                }
            }
        }
        
        // Diff ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
        function toggleDiffSection() {
            const diffSection = document.getElementById('diffSection');
            if (diffSection) {
                if (diffSection.style.display === 'none' || diffSection.style.display === '') {
                    diffSection.style.display = 'block';
                    // í˜ë¥´ì†Œë‚˜ ëª©ë¡ ë¡œë“œ
                    loadPersonasForDiff();
                    console.log('âœ… Diff ì„¹ì…˜ í‘œì‹œë¨');
                } else {
                    diffSection.style.display = 'none';
                    console.log('ğŸ”„ Diff ì„¹ì…˜ ìˆ¨ê¹€');
                }
            }
        }

        // Side-by-Side Diff ìƒì„±
        async function generateDiff() {
            const personaA = document.getElementById('personaA').value;
            const personaB = document.getElementById('personaB').value;
            const questionIndex = document.getElementById('questionSelect').value;
            
            if (!personaA || !personaB) {
                alert('ë‘ í˜ë¥´ì†Œë‚˜ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (personaA === personaB) {
                alert('ì„œë¡œ ë‹¤ë¥¸ í˜ë¥´ì†Œë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (questionIndex === '') {
                alert('ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
            console.log('Diff ìš”ì²­ ë°ì´í„°:', {
                persona_a: personaA,
                persona_b: personaB,
                question_index: questionIndex,
                experiment_data: currentExperiment
            });
            
            // ì‹¤í—˜ ë°ì´í„° êµ¬ì¡° í™•ì¸
            if (currentExperiment && currentExperiment.history && currentExperiment.history.length > 0) {
                const history = currentExperiment.history[0];
                console.log('ì‹¤í—˜ ë°ì´í„° êµ¬ì¡° ìƒì„¸ ë¶„ì„:');
                console.log('ìµœìƒìœ„ í‚¤ë“¤:', Object.keys(currentExperiment));
                console.log('history[0] í‚¤ë“¤:', Object.keys(history));
                console.log('history[0] íƒ€ì…:', typeof history);
                
                // history[0]ì˜ ê° í‚¤ ë¶„ì„
                for (const [key, value] of Object.entries(history)) {
                    if (Array.isArray(value)) {
                        console.log(`ğŸ” ${key}: ë°°ì—´ (ê¸¸ì´: ${value.length})`);
                        if (value.length > 0) {
                            console.log(`ğŸ” ${key}[0] ìƒ˜í”Œ:`, value[0]);
                        }
                    } else {
                        console.log(`ğŸ” ${key}: ${typeof value} =`, value);
                    }
                }
                
                // promptsë‚˜ answersê°€ ìˆëŠ”ì§€ í™•ì¸
                if (history.prompts) {
                    console.log('ğŸ” Prompts ë°ì´í„° ìƒ˜í”Œ:', history.prompts.slice(0, 2));
                }
                if (history.answers) {
                    console.log('ğŸ” Answers ë°ì´í„° ìƒ˜í”Œ:', history.answers.slice(0, 2));
                }
                
                // í˜ë¥´ì†Œë‚˜ ë°ì´í„°ê°€ ì–´ë””ì— ìˆëŠ”ì§€ ì°¾ê¸°
                let personaData = null;
                if (history.prompts) {
                    personaData = history.prompts;
                    console.log('âœ… Promptsì—ì„œ í˜ë¥´ì†Œë‚˜ ë°ì´í„° ì°¾ìŒ');
                } else if (history.answers) {
                    personaData = history.answers;
                    console.log('âœ… Answersì—ì„œ í˜ë¥´ì†Œë‚˜ ë°ì´í„° ì°¾ìŒ');
                } else if (Array.isArray(history)) {
                    personaData = history;
                    console.log('âœ… History[0]ì´ ë°°ì—´ë¡œ í˜ë¥´ì†Œë‚˜ ë°ì´í„° ì°¾ìŒ');
                } else {
                    console.log('âŒ í˜ë¥´ì†Œë‚˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                
                if (personaData) {
                    console.log('ğŸ” í˜ë¥´ì†Œë‚˜ ë°ì´í„° ê°œìˆ˜:', personaData.length);
                    console.log('ğŸ” ì²« ë²ˆì§¸ í˜ë¥´ì†Œë‚˜ ìƒ˜í”Œ:', personaData[0]);
                }
            }
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const diffAnalyzeBtn = document.getElementById('diffAnalyzeBtn');
            const diffLoading = document.getElementById('diffLoading');
            if (diffAnalyzeBtn && diffLoading) {
                diffAnalyzeBtn.disabled = true;
                diffAnalyzeBtn.style.backgroundColor = '#6c757d';
                diffLoading.style.display = 'inline';
            }
            
            try {
                const response = await fetch('/visualization/diff', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        experiment_data: currentExperiment,
                        question_index: parseInt(questionIndex),
                        persona_a: personaA,
                        persona_b: personaB
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayDiffResult(result.data);
                } else {
                    const error = await response.json();
                    console.error('âŒ Diff API ì˜¤ë¥˜:', error);
                    alert(`Diff ìƒì„± ì‹¤íŒ¨: ${error.detail}`);
                }
            } catch (error) {
                console.error('Diff ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
                alert('Diff ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ
                const diffAnalyzeBtn = document.getElementById('diffAnalyzeBtn');
                const diffLoading = document.getElementById('diffLoading');
                if (diffAnalyzeBtn && diffLoading) {
                    diffAnalyzeBtn.disabled = false;
                    diffAnalyzeBtn.style.backgroundColor = '#007bff';
                    diffLoading.style.display = 'none';
                }
            }
        }

        // Diff ê²°ê³¼ í‘œì‹œ
        function displayDiffResult(diffData) {
            // ì§ˆë¬¸ í‘œì‹œ
            document.getElementById('diffQuestion').textContent = diffData.question;
            
            // í˜ë¥´ì†Œë‚˜ ì´ë¦„ê³¼ ì‘ë‹µ í‘œì‹œ
            document.getElementById('personaAName').textContent = `í˜ë¥´ì†Œë‚˜ ${diffData.persona_a}`;
            document.getElementById('personaBName').textContent = `í˜ë¥´ì†Œë‚˜ ${diffData.persona_b}`;
            document.getElementById('responseA').textContent = diffData.response_a;
            document.getElementById('responseB').textContent = diffData.response_b;
            
            // ìœ ì‚¬ë„ ì ìˆ˜ í‘œì‹œ
            const similarityPercent = Math.round(diffData.similarity_score * 100);
            document.getElementById('similarityValue').innerHTML = `
                <span style="color: ${similarityPercent > 70 ? '#4caf50' : similarityPercent > 40 ? '#ff9800' : '#f44336'}">
                    ${similarityPercent}%
                </span>
            `;
            
            // ì˜ë¯¸ ì¶•ë³„ ì°¨ì´ í‘œì‹œ
            displayDimensionDiffs(diffData.dimension_differences);
            
            // ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
            displayDiffHighlights(diffData.diff_highlights);
            
            // ìš”ì•½ í‘œì‹œ
            document.getElementById('diffSummaryContent').textContent = diffData.summary;
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('diffContent').style.display = 'block';
        }

        // ì˜ë¯¸ ì¶•ë³„ ì°¨ì´ í‘œì‹œ
        function displayDimensionDiffs(dimensionDiffs) {
            const container = document.getElementById('dimensionDiffsContent');
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
            
            for (const [dimension, diff] of Object.entries(dimensionDiffs)) {
                const dimName = getDimensionDisplayName(dimension);
                const diffColor = diff.difference_level === 'í° ì°¨ì´' ? '#f44336' : 
                                diff.difference_level === 'ì¤‘ê°„ ì°¨ì´' ? '#ff9800' : '#4caf50';
                
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${diffColor};">
                        <h5 style="margin-top: 0; color: #333;">${dimName}</h5>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>í˜ë¥´ì†Œë‚˜ A: <strong>${diff.value_a}</strong></span>
                            <span>í˜ë¥´ì†Œë‚˜ B: <strong>${diff.value_b}</strong></span>
                        </div>
                        <div style="text-align: center; padding: 8px; background-color: #f5f5f5; border-radius: 4px;">
                            <span style="color: ${diffColor}; font-weight: bold;">
                                ì°¨ì´: ${diff.difference} (${diff.difference_percentage}%)
                            </span>
                            <br>
                            <small style="color: #666;">${diff.difference_level} | ${diff.trend}</small>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ì°¨ì´ì  í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
        function displayDiffHighlights(diffHighlights) {
            const container = document.getElementById('diffHighlightsContent');
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            // ê³µí†µ ë‹¨ì–´
            if (diffHighlights.common_words && diffHighlights.common_words.length > 0) {
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                        <h5 style="margin-top: 0; color: #333;font-size: 20px;">ê³µí†µ ë‹¨ì–´</h5>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${diffHighlights.common_words.map(word => `<span style="background-color: #e8f5e8; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${word}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // í˜ë¥´ì†Œë‚˜ A ê³ ìœ  ë‹¨ì–´
            if (diffHighlights.unique_a && diffHighlights.unique_a.length > 0) {
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #1976d2;">
                        <h5 style="margin-top: 0; color: #333; font-size: 20px;">ğŸ‘¤ ${document.getElementById('personaA').value} ê³ ìœ  ë‹¨ì–´</h5>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${diffHighlights.unique_a.map(word => `<span style="background-color: #e3f2fd; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${word}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // í˜ë¥´ì†Œë‚˜ B ê³ ìœ  ë‹¨ì–´
            if (diffHighlights.unique_b && diffHighlights.unique_b.length > 0) {
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #7b1fa2;">
                        <h5 style="margin-top: 0; color: #333; font-size: 20px;">ğŸ‘¤ ${document.getElementById('personaB').value} ê³ ìœ  ë‹¨ì–´</h5>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${diffHighlights.unique_b.map(word => `<span style="background-color: #f3e5f5; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${word}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ê°ì • í‚¤ì›Œë“œ ë¶„ì„
            if (diffHighlights.emotion_a || diffHighlights.emotion_b) {
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h5 style="margin-top: 0; color: #333; font-size: 15px;">ê°ì • í‚¤ì›Œë“œ ë¶„ì„</h5>
                        <div style="display: flex; gap: 20px;">
                            <div>
                                <strong>${document.getElementById('personaA').value}:</strong><br>
                                ê¸ì •: ${diffHighlights.emotion_a?.positive || 0} | 
                                ë¶€ì •: ${diffHighlights.emotion_a?.negative || 0} | 
                                ì¤‘ë¦½: ${diffHighlights.emotion_a?.neutral || 0}
                            </div>
                            <div>
                                <strong>${document.getElementById('personaB').value}:</strong><br>
                                ê¸ì •: ${diffHighlights.emotion_b?.positive || 0} | 
                                ë¶€ì •: ${diffHighlights.emotion_b?.negative || 0} | 
                                ì¤‘ë¦½: ${diffHighlights.emotion_b?.neutral || 0}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ë’¤ë¡œê°€ê¸°
        function goBack() {
            window.location.href = '/';
        }

        // êµ¬ì¡°í™”ëœ ë¶„ì„ ìƒì„±
        async function generateStructuredAnalysis() {
            if (!currentExperiment || currentQuestion === null) {
                alert('ì‹¤í—˜ê³¼ ì§ˆë¬¸ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const includeEmbeddings = document.getElementById('includeEmbeddings').checked;
            const includeSimilarities = document.getElementById('includeSimilarities').checked;
            const analysisDepth = document.getElementById('analysisDepth').value;
            
            // ì„ íƒëœ ì§ˆë¬¸ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            const selectedQuestionText = getSelectedQuestionText();
            
            try {
                const response = await fetch('/visualization/structured-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        experiment_data: currentExperiment,
                        question_index: parseInt(currentQuestion),
                        question_text: selectedQuestionText, // ì„ íƒëœ ì§ˆë¬¸ í…ìŠ¤íŠ¸ ì „ë‹¬
                        include_embeddings: includeEmbeddings,
                        include_similarities: includeSimilarities,
                        analysis_depth: analysisDepth
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // ìºì‹œì—ì„œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸ (ì½˜ì†”ì—ë§Œ ë¡œê·¸, ì‚¬ìš©ìì—ê²ŒëŠ” ì•Œë¦¼í•˜ì§€ ì•ŠìŒ)
                        if (result.loaded_from_cache) {
                            console.log('âœ… ê¸°ì¡´ êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼ë¥¼ ìºì‹œì—ì„œ ë¡œë“œí–ˆìŠµë‹ˆë‹¤');
                        } else {
                            console.log('ğŸ”„ ìƒˆë¡œìš´ êµ¬ì¡°í™”ëœ ë¶„ì„ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤');
                        }
                        
                        displayStructuredAnalysis(result.data);
                        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë‹¤ìš´ë¡œë“œìš©)
                        window.currentStructuredAnalysis = result.data;
                        
                        // êµ¬ì¡°í™”ëœ ë¶„ì„ ë¡œë”© ì™„ë£Œ
                        hideSpecificLoading('structuredAnalysis');
                    } else {
                        throw new Error(result.message || 'êµ¬ì¡°í™”ëœ ë¶„ì„ ìƒì„± ì‹¤íŒ¨');
                    }
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('êµ¬ì¡°í™”ëœ ë¶„ì„ ìƒì„± ì‹¤íŒ¨:', error);
                
                // êµ¬ì¡°í™”ëœ ë¶„ì„ ë¡œë”© ì™„ë£Œ (ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„)
                hideSpecificLoading('structuredAnalysis');
                
                // ë” ìì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                let errorMessage = 'êµ¬ì¡°í™”ëœ ë¶„ì„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message;
                if (error.message.includes('answers ë°°ì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤')) {
                    errorMessage = 'êµ¬ì¡°í™”ëœ ë¶„ì„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ì„ íƒí•œ ì‹¤í—˜ì˜ ì‘ë‹µ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‹¤í—˜ì„ ì„ íƒí•˜ê±°ë‚˜ ì‘ë‹µ ë°ì´í„°ê°€ ìˆëŠ” ì‹¤í—˜ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.';
                }
                alert(errorMessage);
            }
        }

        // êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayStructuredAnalysis(data) {
            // ì§ˆë¬¸ ì •ë³´ í‘œì‹œ (questionDetails divê°€ ì œê±°ë˜ì–´ ë¹„í™œì„±í™”)
            // displayQuestionInfo(data);
            
            // í˜ë¥´ì†Œë‚˜ë³„ ì‘ë‹µ ë¶„ì„ í‘œì‹œ
            displayPersonaResponses(data.persona_responses);
            
            // ìœ ì‚¬ë„ ë§¤íŠ¸ë¦­ìŠ¤ í‘œì‹œ
            if (data.similarities && data.similarities.length > 0) {
                displaySimilarityMatrix(data.similarities, data.persona_responses);
            }
            
            // ì „ì²´ í†µê³„ í‘œì‹œ
            displayOverallStatistics(data.overall_statistics);
            
            // ëª¨ë¸ ì •ë³´ í‘œì‹œ
            displayModelInfo(data.model_info);
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('structuredAnalysisContent').style.display = 'block';
        }

        // ì§ˆë¬¸ ì •ë³´ í‘œì‹œ
        function displayQuestionInfo(data) {
            // questionDetails divê°€ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ë¹„í™œì„±í™”
            console.log('ğŸ” displayQuestionInfo í˜¸ì¶œë¨ - questionDetails divê°€ ì œê±°ë˜ì–´ í‘œì‹œí•˜ì§€ ì•ŠìŒ');
            return;
            
            const container = document.getElementById('questionDetails');
            
            // ì§ˆë¬¸ í…ìŠ¤íŠ¸ê°€ ê¸°ë³¸ê°’ì¸ì§€ í™•ì¸
            const isDefaultQuestion = data.question_text.startsWith('ì§ˆë¬¸ ') && data.question_text.includes('ì§ˆë¬¸');
            
            let html = `
                
                <div style="background-color: white; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #1976d2;">
                    <strong>ì§ˆë¬¸ ë‚´ìš©:</strong><br>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 16px; line-height: 1.5;">
                        ${isDefaultQuestion ? 
                            `<span style="color: #dc3545; font-style: italic;">âš ï¸ ì‹¤ì œ ì§ˆë¬¸ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’: ${data.question_text}</span>` : 
                            data.question_text
                        }
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // í˜ë¥´ì†Œë‚˜ë³„ ì‘ë‹µ ë¶„ì„ í‘œì‹œ
        function displayPersonaResponses(personaResponses) {
            const container = document.getElementById('personaResponsesContent');
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">';
            
            personaResponses.forEach((pr, index) => {
                const color = getColorForIndex(index);
                html += `
                    <div style="background-color: white; padding: 20px; border-radius: 8px; border-left: 4px solid ${color}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h5 style="margin-top: 0; color: #333; border-bottom: 2px solid ${color}; padding-bottom: 10px; cursor: pointer;" 
                             onclick="goToPersonaDetail('${pr.persona}')" 
                             class="clickable-persona">
                            ğŸ‘¤ ${pr.persona}
                        </h5>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>ì‘ë‹µ í…ìŠ¤íŠ¸:</strong><br>
                            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 5px; line-height: 1.6;">
                                <div id="highlightedText_${index}"></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>ì˜ë¯¸ íƒœê·¸:</strong><br>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 5px;">
                                <span style="background-color: #e3f2fd; padding: 4px 8px; border-radius: 12px; font-size: 17px;">
                                    ê°ì •: ${pr.tags.ê°ì •_ë°©í–¥} (${pr.tags.ê°ì •_ê°•ë„})
                                </span>
                                <span style="background-color: #e8f5e8; padding: 4px 8px; border-radius: 12px; font-size: 17px;">
                                    í–‰ë™: ${pr.tags.í–‰ë™_ì„±í–¥}
                                </span>
                                <span style="background-color: #fff3e0; padding: 4px 8px; border-radius: 12px; font-size: 17px;">
                                    ê´€ê³„: ${pr.tags.ê´€ê³„_ì§€í–¥ì„±}
                                </span>
                                <span style="background-color: #fce4ec; padding: 4px 8px; border-radius: 12px; font-size: 17px;">
                                    í‘œí˜„: ${pr.tags.í‘œí˜„_ìŠ¤íƒ€ì¼}
                                </span>
                            </div>
                        </div>
                        
                        <!-- ì˜ë¯¸ ì¶• ì ìˆ˜ëŠ” ì œê±°ë¨ -->
                        
                        <!-- ë©”íƒ€ë°ì´í„°ëŠ” ì œê±°ë¨ -->
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // ê° ì‘ë‹µ í…ìŠ¤íŠ¸ì— ë‰˜ì•™ìŠ¤ ê¸°ë°˜ í•˜ì´ë¼ì´íŠ¸ ì ìš©
            personaResponses.forEach((pr, index) => {
                const highlightedContainer = document.getElementById(`highlightedText_${index}`);
                if (highlightedContainer) {
                    // ë‰˜ì•™ìŠ¤ ê¸°ë°˜ í•˜ì´ë¼ì´íŠ¸ ì ìš©
                    const highlightedText = highlightTagsInText(pr.text, pr.tags);
                    highlightedContainer.innerHTML = highlightedText;
                }
            });
        }

        // ìœ ì‚¬ë„ ë§¤íŠ¸ë¦­ìŠ¤ í‘œì‹œ
        function displaySimilarityMatrix(similarities, personaResponses) {
            const container = document.getElementById('similarityMatrixContent');
            const personas = personaResponses.map(pr => pr.persona);
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
            
            // í—¤ë”
            html += '<thead><tr><th style="border: 1px solid #ddd; padding: 12px; background-color: #f8f9fa; text-align: center;">í˜ë¥´ì†Œë‚˜</th>';
            personas.forEach(persona => {
                html += `<th style="border: 1px solid #ddd; padding: 12px; background-color: #f8f9fa; text-align: center;">${persona}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // ë°ì´í„° í–‰
            personas.forEach((personaA, i) => {
                html += `<tr><td style="border: 1px solid #ddd; padding: 12px; background-color: #f8f9fa; font-weight: bold;">${personaA}</td>`;
                
                personas.forEach((personaB, j) => {
                    if (i === j) {
                        html += '<td style="border: 1px solid #ddd; padding: 12px; text-align: center; background-color: #e9ecef;">-</td>';
                    } else {
                        const similarity = similarities.find(s => 
                            (s.persona_a === personaA && s.persona_b === personaB) ||
                            (s.persona_a === personaB && s.persona_b === personaA)
                        );
                        
                        if (similarity) {
                            const score = similarity.score;
                            const color = score > 0.7 ? '#d4edda' : score > 0.4 ? '#fff3cd' : '#f8d7da';
                            const textColor = score > 0.7 ? '#155724' : score > 0.4 ? '#856404' : '#721c24';
                            
                            html += `<td style="border: 1px solid #ddd; padding: 12px; text-align: center; background-color: ${color}; color: ${textColor}; font-weight: bold;">
                                ${(score * 100).toFixed(1)}%
                            </td>`;
                        } else {
                            html += '<td style="border: 1px solid #ddd; padding: 12px; text-align: center;">N/A</td>';
                        }
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ì „ì²´ í†µê³„ í‘œì‹œ
        function displayOverallStatistics(statistics) {
            const container = document.getElementById('overallStatisticsContent');
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            // ê¸°ë³¸ í†µê³„ (ë©”íƒ€ë°ì´í„° ì œê±°)
            html += `
                <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h5 style="margin-top: 0; color: #333;">ğŸ“Š ê¸°ë³¸ í†µê³„</h5>
                    <div>ì´ ì‘ë‹µ: <strong>${statistics.response_count}</strong>ê°œ</div>
                </div>
            `;
            
            // ê°ì • ë¶„í¬
            if (statistics.emotion_distribution) {
                const emotionDir = statistics.emotion_distribution.direction;
                const emotionInt = statistics.emotion_distribution.intensity;
                
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <h5 style="margin-top: 0; color: #333;">ğŸ˜Š ê°ì • ë¶„í¬</h5>
                        <div><strong>ë°©í–¥:</strong></div>
                        ${Object.entries(emotionDir).map(([dir, count]) => 
                            `<div style="margin-left: 10px;">${dir}: ${count}ê°œ</div>`
                        ).join('')}
                        <div style="margin-top: 10px;"><strong>ê°•ë„:</strong></div>
                        ${Object.entries(emotionInt).map(([intensity, count]) => 
                            `<div style="margin-left: 10px;">${intensity}: ${count}ê°œ</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            // ì˜ë¯¸ ì¶• í‰ê· 
            if (statistics.dimension_averages) {
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <h5 style="margin-top: 0; color: #333;">ğŸ“ˆ ì˜ë¯¸ ì¶• í‰ê· </h5>
                        ${Object.entries(statistics.dimension_averages).map(([dim, avg]) => 
                            `<div>${getDimensionDisplayName(dim)}: <strong>${avg}</strong></div>`
                        ).join('')}
                    </div>
                `;
            }
            
            // ìœ ì‚¬ë„ í†µê³„
            if (statistics.similarity_statistics && Object.keys(statistics.similarity_statistics).length > 0) {
                const simStats = statistics.similarity_statistics;
                html += `
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <h5 style="margin-top: 0; color: #333;">ğŸ”— ìœ ì‚¬ë„ í†µê³„</h5>
                        <div>ìµœì†Œ: <strong>${(simStats.min_similarity * 100).toFixed(1)}%</strong></div>
                        <div>ìµœëŒ€: <strong>${(simStats.max_similarity * 100).toFixed(1)}%</strong></div>
                        <div>í‰ê· : <strong>${(simStats.avg_similarity * 100).toFixed(1)}%</strong></div>
                        <div>ì´ ë¹„êµ: <strong>${simStats.total_comparisons}</strong>ê°œ</div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ëª¨ë¸ ì •ë³´ í‘œì‹œ
        function displayModelInfo(modelInfo) {
            const container = document.getElementById('modelInfoContent');
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2e7d32;">
                        <strong>LLM ëª¨ë¸:</strong><br>${modelInfo.llm_model}
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2e7d32;">
                        <strong>ì„ë² ë”© ëª¨ë¸:</strong><br>${modelInfo.embedding_model}
                    </div>
                    <div style="background-color: white; padding: 15px; border-radius: 8px; border-left: 4px solid #2e7d32;">
                        <strong>ë¶„ì„ ë²„ì „:</strong><br>${modelInfo.analysis_version}
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        // êµ¬ì¡°í™”ëœ ë¶„ì„ ê²°ê³¼ JSON ë‹¤ìš´ë¡œë“œ
        function downloadStructuredAnalysis() {
            if (!window.currentStructuredAnalysis) {
                alert('ë¨¼ì € êµ¬ì¡°í™”ëœ ë¶„ì„ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const dataStr = JSON.stringify(window.currentStructuredAnalysis, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `structured_analysis_${window.currentStructuredAnalysis.question_id}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }



















        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // ì•Œë¦¼ ìš”ì†Œ ìƒì„±
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì„¤ì •
            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'info') {
                notification.style.backgroundColor = '#17a2b8';
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#ffc107';
                notification.style.color = '#212529';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            }
            
            notification.textContent = message;
            
            // í˜ì´ì§€ì— ì¶”ê°€
            document.body.appendChild(notification);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>

