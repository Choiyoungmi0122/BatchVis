<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ìœ ì‚¬ë„ ë¶„ì„</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #F0F7FB;
      font-family: 'Roboto', sans-serif;
    }

    .container {
      width: 96%;
      padding: 32px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #8E12D5;
    }

    .back-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .back-btn:hover {
      background: #5a6268;
    }

    .page-header h1 {
      margin: 0;
      color: #3D2D4C;
      font-size: 32px;
      font-weight: 700;
    }

    .analysis-controls {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    .control-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: end;
    }

    .control-group {
      flex: 1;
    }

    .control-group label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }

    .control-group select {
      width: 100%;
      height: 40px;
      font-size: 16px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .analysis-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    
    .analysis-btn:hover {
      background: #0056b3;
    }
    
    .analysis-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .file-selection {
      margin-top: 20px;
    }

    .file-selection label {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: block;
    }

    .file-selection .file-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      background: #fafafa;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease;
    }

    .file-item:hover {
      background-color: #f8f9fa;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-item input[type="checkbox"] {
      margin-right: 12px;
      transform: scale(1.1);
    }

    .file-item label {
      flex: 1;
      cursor: pointer;
      padding: 4px 0;
      margin: 0;
    }

    .estimated-time {
      margin-top: 15px;
      padding: 12px;
      background: #e8f4fd;
      border: 1px solid #bee5eb;
      border-radius: 6px;
      text-align: center;
      display: none;
    }

    .estimated-time .time-display {
      color: #8E12D5;
      font-weight: 600;
      font-size: 18px;
    }

    .analysis-results {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }

    .results-header h3 {
      margin: 0;
      color: #333;
      font-size: 20px;
      font-weight: 600;
    }

    .result-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }

    .action-btn:hover {
      background: #218838;
    }

    .analysis-content {
      margin-top: 20px;
    }

    .stats-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .stats-section h4 {
      margin: 0 0 15px 0;
      color: #333;
      font-size: 16px;
      font-weight: 600;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .stat-item {
      background: white;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #007bff;
    }

    .stat-item h5 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 14px;
      font-weight: 600;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .success-message {
      color: #155724;
      background: #d4edda;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #c3e6cb;
      margin: 15px 0;
    }

    .error-message {
      color: #dc3545;
      background: #f8d7da;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #f5c6cb;
      margin: 15px 0;
    }

    .loading {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 40px;
    }

    .visualization-container {
      text-align: center;
      margin-top: 20px;
    }

    .visualization-container img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .no-files-message {
      color: #666;
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px dashed #ccc;
    }

    .no-files-message .icon {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .no-files-message .title {
      font-size: 16px;
      margin-bottom: 8px;
    }

    .no-files-message .subtitle {
      font-size: 14px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <a href="/" class="back-btn">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      <h1>ğŸ” í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ìœ ì‚¬ë„ ë¶„ì„</h1>
    </div>
    
    <div class="analysis-controls">
      <div class="control-row">
        <div class="control-group">
          <label for="analysisType">ğŸ” ë¶„ì„ ìœ í˜•:</label>
          <select id="analysisType" onchange="updateEstimatedTime()">
            <option value="all">ğŸ“Š ì „ì²´ ë¶„ì„ (ê¶Œì¥)</option>
            <option value="similarity_matrix">ğŸ“ˆ ìœ ì‚¬ë„ í–‰ë ¬ë§Œ</option>
            <option value="clustering">ğŸ” í´ëŸ¬ìŠ¤í„°ë§</option>
            <option value="dimensionality_reduction">ğŸ“‰ ì°¨ì› ì¶•ì†Œ</option>
          </select>
        </div>
        <div class="control-group">
          <button id="startAnalysisBtn" class="analysis-btn" onclick="startSimilarityAnalysis()">ğŸš€ ë¶„ì„ ì‹œì‘</button>
        </div>
      </div>
      
      <div class="file-selection">
        <label>ğŸ“ ë¶„ì„í•  ì‹¤í—˜ íŒŒì¼ ì„ íƒ:</label>
        <div id="experimentFileList" class="file-list">
          <div class="no-files-message">
            <div class="icon">ğŸ“</div>
            <div class="title">ë¶„ì„í•  ì‹¤í—˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="subtitle">ë¨¼ì € ì‹¤í—˜ì„ ì‹¤í–‰í•˜ì—¬ ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</div>
          </div>
        </div>
        <div id="estimatedTimeInfo" class="estimated-time">
          <div style="font-size: 14px; color: #0c5460;">
            <span style="font-weight: 600;">â±ï¸ ì˜ˆìƒ ë¶„ì„ ì‹œê°„:</span>
            <span id="estimatedTimeDisplay" class="time-display"></span>
          </div>
        </div>
      </div>
    </div>
    
    <div id="analysisResults" class="analysis-results">
      <div class="results-header">
        <h3>ë¶„ì„ ê²°ê³¼</h3>
        <div class="result-actions">
          <button id="showStatsBtn" class="action-btn" onclick="showDetailedStats()">í†µê³„ ë³´ê¸°</button>
          <button id="showVisualizationBtn" class="action-btn" onclick="showVisualizations()">ì‹œê°í™”</button>
          <button id="exportResultsBtn" class="action-btn" onclick="exportAnalysisResults()">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
        </div>
      </div>
      
      <div id="analysisContent">
        <div class="loading">ë¶„ì„ ì¤‘...</div>
      </div>
    </div>
  </div>

  <script>
    // ìœ ì‚¬ë„ ë¶„ì„ ê²°ê³¼ ì €ì¥
    let currentAnalysisResult = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í—˜ íŒŒì¼ ëª©ë¡ ë¡œë“œ
    window.addEventListener('DOMContentLoaded', () => {
      loadExperimentFiles();
    });

    // ì‹¤í—˜ íŒŒì¼ ëª©ë¡ ë¡œë“œ
    async function loadExperimentFiles() {
      try {
        const res = await fetch('/list_experiments');
        if (res.ok) {
          const experiments = await res.json();
          const fileList = document.getElementById('experimentFileList');
          
          if (experiments.length === 0) {
            fileList.innerHTML = `
              <div class="no-files-message">
                <div class="icon">ğŸ“</div>
                <div class="title">ë¶„ì„í•  ì‹¤í—˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="subtitle">ë¨¼ì € ì‹¤í—˜ì„ ì‹¤í–‰í•˜ì—¬ ë°ì´í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</div>
              </div>
            `;
            return;
          }
          
          let fileListHTML = '';
          experiments.forEach(exp => {
            const isChecked = experiments.length === 1 ? 'checked' : ''; // íŒŒì¼ì´ í•˜ë‚˜ë©´ ìë™ ì„ íƒ
            fileListHTML += `
              <div class="file-item">
                <input type="checkbox" id="file_${exp.filename}" value="${exp.filename}" ${isChecked} onchange="updateEstimatedTime()">
                <label for="file_${exp.filename}">
                  <strong>${exp.name}</strong><br>
                  <small style="color: #666;">${exp.date} | ${exp.age}ì„¸ | ${exp.symptom}</small>
                </label>
              </div>
            `;
          });
          fileList.innerHTML = fileListHTML;
          
          // ì´ˆê¸° ì˜ˆìƒ ì‹œê°„ í‘œì‹œ
          updateEstimatedTime();
        }
      } catch (error) {
        console.error('ì‹¤í—˜ íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('experimentFileList').innerHTML = '<div class="error-message">íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }

    // ì„ íƒëœ ì‹¤í—˜ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
    function getSelectedExperimentFiles() {
      const checkboxes = document.querySelectorAll('#experimentFileList input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
    function calculateEstimatedTime(fileCount, analysisType) {
      // íŒŒì¼ë‹¹ í‰ê·  ì‘ë‹µ ìˆ˜ (ì‹¤í—˜ ë°ì´í„° ê¸°ë°˜ ì¶”ì •)
      const avgResponsesPerFile = 15; // í˜ë¥´ì†Œë‚˜ ì¡°í•©ë‹¹ 3ê°œ ì‘ë‹µ Ã— 5ê°œ ì¡°í•©
      const totalResponses = fileCount * avgResponsesPerFile;
      
      // ë¶„ì„ ìœ í˜•ë³„ ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
      let baseTime = 0;
      
      // ê¸°ë³¸ ì„ë² ë”© ìƒì„± ì‹œê°„ (ì‘ë‹µ ìˆ˜ì— ë¹„ë¡€)
      baseTime += totalResponses * 0.5; // ì‘ë‹µë‹¹ ì•½ 0.5ì´ˆ
      
      // ë¶„ì„ ìœ í˜•ë³„ ì¶”ê°€ ì‹œê°„
      switch(analysisType) {
        case 'similarity_matrix':
          baseTime += totalResponses * 0.1; // ìœ ì‚¬ë„ í–‰ë ¬ë§Œ
          break;
        case 'clustering':
          baseTime += totalResponses * 0.3; // í´ëŸ¬ìŠ¤í„°ë§ ì¶”ê°€
          break;
        case 'dimensionality_reduction':
          baseTime += totalResponses * 0.4; // ì°¨ì› ì¶•ì†Œ ì¶”ê°€
          break;
        case 'all':
        default:
          baseTime += totalResponses * 0.6; // ì „ì²´ ë¶„ì„
          break;
      }
      
      // ìµœì†Œ ì‹œê°„ ë³´ì¥
      baseTime = Math.max(baseTime, 10);
      
      // ì‹œê°„ í¬ë§·íŒ…
      if (baseTime < 60) {
        return `${Math.ceil(baseTime)}ì´ˆ`;
      } else if (baseTime < 3600) {
        return `${Math.ceil(baseTime / 60)}ë¶„`;
      } else {
        return `${Math.ceil(baseTime / 3600)}ì‹œê°„`;
      }
    }

    // ì˜ˆìƒ ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateEstimatedTime() {
      const selectedFiles = getSelectedExperimentFiles();
      const analysisType = document.getElementById('analysisType').value;
      const timeInfo = document.getElementById('estimatedTimeInfo');
      const timeDisplay = document.getElementById('estimatedTimeDisplay');
      
      if (selectedFiles.length === 0) {
        timeInfo.style.display = 'none';
        return;
      }
      
      const estimatedTime = calculateEstimatedTime(selectedFiles.length, analysisType);
      timeDisplay.textContent = estimatedTime;
      timeInfo.style.display = 'block';
    }

    // ìœ ì‚¬ë„ ë¶„ì„ ì‹œì‘
    async function startSimilarityAnalysis() {
      const selectedFiles = getSelectedExperimentFiles();
      if (selectedFiles.length === 0) {
        alert('ë¶„ì„í•  ì‹¤í—˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const analysisType = document.getElementById('analysisType').value;
      const startBtn = document.getElementById('startAnalysisBtn');
      const resultsDiv = document.getElementById('analysisResults');
      const contentDiv = document.getElementById('analysisContent');

      // ë¶„ì„ ì‹œê°„ ì˜ˆìƒì¹˜ ê³„ì‚°
      const estimatedTime = calculateEstimatedTime(selectedFiles.length, analysisType);

      // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
      startBtn.disabled = true;
      startBtn.textContent = 'ë¶„ì„ ì¤‘...';
      
      // ê²°ê³¼ ì˜ì—­ í‘œì‹œ ë° ë¡œë”© ë©”ì‹œì§€
      resultsDiv.style.display = 'block';
      contentDiv.innerHTML = `
        <div class="loading">
          <div style="font-size: 20px; margin-bottom: 15px; color: #8E12D5; font-weight: 600;">í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ìœ ì‚¬ë„ ë¶„ì„ ì¤‘...</div>
          <div style="font-size: 16px; margin-bottom: 8px;">ğŸ“Š ì„ íƒëœ íŒŒì¼: <strong>${selectedFiles.length}</strong>ê°œ</div>
          <div style="font-size: 14px; color: #999; margin-bottom: 20px;">ë¶„ì„ ìœ í˜•: <strong>${analysisType === 'all' ? 'ì „ì²´ ë¶„ì„' : analysisType}</strong></div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #8E12D5; text-align: left; max-width: 400px; margin: 0 auto;">
            <div style="font-weight: 600; margin-bottom: 8px;">ë¶„ì„ ì¤‘ì¸ íŒŒì¼:</div>
            ${selectedFiles.map(file => `<div style="margin-bottom: 4px; font-size: 13px;">â€¢ ${file}</div>`).join('')}
          </div>
          <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; color: #856404;">
            <div style="font-weight: 600; margin-bottom: 5px;">â±ï¸ ì˜ˆìƒ ë¶„ì„ ì‹œê°„:</div>
            <div style="font-size: 16px; color: #8E12D5; font-weight: 600;">${estimatedTime}</div>
            <div style="font-size: 12px; margin-top: 5px; color: #856404;">
              * ì‘ë‹µ ìˆ˜ì™€ ë¶„ì„ ìœ í˜•ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
              * ì„ë² ë”© ìƒì„±: ê°€ì¥ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ë‹¨ê³„<br>
              * í´ëŸ¬ìŠ¤í„°ë§/ì°¨ì›ì¶•ì†Œ: ì‘ë‹µ ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ì‹œê°„ ì¦ê°€
            </div>
          </div>
          <div style="margin-top: 20px; color: #8E12D5; font-size: 14px;">ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì ì‹œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
        </div>
      `;

      try {
        const response = await fetch('/analysis/similarity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            experiment_files: selectedFiles,
            analysis_type: analysisType
          })
        });

        if (response.ok) {
          const result = await response.json();
          currentAnalysisResult = result; // ë¶„ì„ ê²°ê³¼ ì €ì¥
          displayAnalysisResults(result, selectedFiles);
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ë¶„ì„ ì‹¤íŒ¨');
        }
      } catch (error) {
        contentDiv.innerHTML = `
          <div class="error-message">
            <strong>ë¶„ì„ ì˜¤ë¥˜:</strong> ${error.message}
          </div>
        `;
      } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸš€ ë¶„ì„ ì‹œì‘';
      }
    }

    // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
    function displayAnalysisResults(result, selectedFiles) {
      const contentDiv = document.getElementById('analysisContent');
      
      let contentHTML = `
        <div class="success-message">
          <strong>ğŸ‰ ë¶„ì„ ì™„ë£Œ!</strong> ${selectedFiles.length}ê°œ íŒŒì¼ì—ì„œ ì´ ${result.total_responses}ê°œ ì‘ë‹µì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.
        </div>
        
        <div class="stats-section">
          <h4>ğŸ“Š ê¸°ë³¸ í†µê³„</h4>
          <div class="stats-grid">
            <div class="stat-item">
              <h5>ì´ ì‘ë‹µ ìˆ˜</h5>
              <div class="stat-value">${result.total_responses}</div>
            </div>
            <div class="stat-item">
              <h5>ë¶„ì„ íŒŒì¼ ìˆ˜</h5>
              <div class="stat-value">${selectedFiles.length}</div>
            </div>
          </div>
        </div>
      `;

      if (result.clustering) {
        contentHTML += `
          <div class="stats-section">
            <h4>ğŸ” í´ëŸ¬ìŠ¤í„°ë§ ê²°ê³¼</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <h5>K-means í´ëŸ¬ìŠ¤í„°</h5>
                <div class="stat-value">${result.clustering.n_clusters_kmeans}</div>
              </div>
              <div class="stat-item">
                <h5>DBSCAN í´ëŸ¬ìŠ¤í„°</h5>
                <div class="stat-value">${result.clustering.n_clusters_dbscan}</div>
              </div>
            </div>
          </div>
        `;
      }

      contentHTML += `
        <div class="stats-section">
          <h4>ğŸ“ ë¶„ì„ëœ íŒŒì¼ ëª©ë¡</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
            ${selectedFiles.map(file => `<div style="margin-bottom: 5px; font-size: 14px;">âœ… ${file}</div>`).join('')}
          </div>
        </div>
      `;

      contentDiv.innerHTML = contentHTML;
    }

    // ìƒì„¸ í†µê³„ ë³´ê¸°
    async function showDetailedStats() {
      if (!currentAnalysisResult) {
        alert('ë¨¼ì € ìœ ì‚¬ë„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      const contentDiv = document.getElementById('analysisContent');
      const similarityMatrix = currentAnalysisResult.similarity_matrix;
      const responsesInfo = currentAnalysisResult.responses_info;
      
      let statsHTML = `
        <div class="success-message">
          <strong>ğŸ“Š ìƒì„¸ í†µê³„ ë¶„ì„ ê²°ê³¼</strong>
        </div>
        
        <div class="stats-section">
          <h4>ğŸ” ìœ ì‚¬ë„ í†µê³„</h4>
          <div class="stats-grid">
            <div class="stat-item">
              <h5>ì „ì²´ ì‘ë‹µ ìˆ˜</h5>
              <div class="stat-value">${responsesInfo.length}</div>
            </div>
            <div class="stat-item">
              <h5>ìœ ì‚¬ë„ í–‰ë ¬ í¬ê¸°</h5>
              <div class="stat-value">${similarityMatrix.length} Ã— ${similarityMatrix[0].length}</div>
            </div>
          </div>
        </div>
      `;

      // ìœ ì‚¬ë„ ê°’ í†µê³„ ê³„ì‚°
      const allSimilarities = [];
      for (let i = 0; i < similarityMatrix.length; i++) {
        for (let j = i + 1; j < similarityMatrix[i].length; j++) {
          allSimilarities.push(similarityMatrix[i][j]);
        }
      }
      
      if (allSimilarities.length > 0) {
        const avgSimilarity = allSimilarities.reduce((a, b) => a + b, 0) / allSimilarities.length;
        const maxSimilarity = Math.max(...allSimilarities);
        const minSimilarity = Math.min(...allSimilarities);
        
        statsHTML += `
          <div class="stats-section">
            <h4>ğŸ“ˆ ìœ ì‚¬ë„ ê°’ ë¶„í¬</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <h5>í‰ê·  ìœ ì‚¬ë„</h5>
                <div class="stat-value">${avgSimilarity.toFixed(3)}</div>
              </div>
              <div class="stat-item">
                <h5>ìµœëŒ€ ìœ ì‚¬ë„</h5>
                <div class="stat-value">${maxSimilarity.toFixed(3)}</div>
              </div>
              <div class="stat-item">
                <h5>ìµœì†Œ ìœ ì‚¬ë„</h5>
                <div class="stat-value">${minSimilarity.toFixed(3)}</div>
              </div>
            </div>
          </div>
        `;
      }

      // í´ëŸ¬ìŠ¤í„°ë§ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
      if (currentAnalysisResult.clustering) {
        const clustering = currentAnalysisResult.clustering;
        statsHTML += `
          <div class="stats-section">
            <h4>ğŸ” í´ëŸ¬ìŠ¤í„°ë§ ìƒì„¸ ê²°ê³¼</h4>
            <div class="stats-grid">
              <div class="stat-item">
                <h5>K-means í´ëŸ¬ìŠ¤í„° ìˆ˜</h5>
                <div class="stat-value">${clustering.n_clusters_kmeans}</div>
              </div>
              <div class="stat-item">
                <h5>DBSCAN í´ëŸ¬ìŠ¤í„° ìˆ˜</h5>
                <div class="stat-value">${clustering.n_clusters_dbscan}</div>
              </div>
            </div>
          </div>
        `;
      }

      // ì‘ë‹µë³„ ìƒì„¸ ì •ë³´
      statsHTML += `
        <div class="stats-section">
          <h4>ğŸ“ ì‘ë‹µë³„ ìƒì„¸ ì •ë³´</h4>
          <div style="max-height: 300px; overflow-y: auto;">
      `;
      
      responsesInfo.forEach((response, index) => {
        statsHTML += `
          <div style="background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #007bff;">
            <div style="font-weight: 600; margin-bottom: 8px;">ì‘ë‹µ #${index + 1}</div>
            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
              <strong>íŒŒì¼:</strong> ${response.filename} | 
              <strong>ì„±ê²©:</strong> ${response.personality}
            </div>
            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">
              <strong>ì§ˆë¬¸:</strong> ${response.question}
            </div>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 14px;">
              ${response.answer}
            </div>
          </div>
        `;
      });
      
      statsHTML += `
          </div>
        </div>
      `;

      contentDiv.innerHTML = statsHTML;
    }

    // ì‹œê°í™” ë³´ê¸°
    async function showVisualizations() {
      if (!currentAnalysisResult) {
        alert('ë¨¼ì € ìœ ì‚¬ë„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      const contentDiv = document.getElementById('analysisContent');
      
      // ì‹œê°í™” ìƒì„± ì¤‘ ë¡œë”© í‘œì‹œ
      contentDiv.innerHTML = `
        <div class="loading">
          <div style="font-size: 18px; margin-bottom: 15px; color: #8E12D5;">ğŸ¨ ì‹œê°í™” ìƒì„± ì¤‘...</div>
          <div style="font-size: 14px; color: #999;">ì°¨íŠ¸ì™€ ê·¸ë˜í”„ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      `;

      try {
        const response = await fetch('/visualization/similarity', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            analysis_result: currentAnalysisResult
          })
        });

        if (response.ok) {
          const vizResult = await response.json();
          
          let vizHTML = `
            <div class="success-message">
              <strong>ğŸ¨ ì‹œê°í™” ìƒì„± ì™„ë£Œ!</strong>
            </div>
          `;

          // ì‹œê°í™” ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ í‘œì‹œ
          if (vizResult.visualization) {
            vizHTML += `
              <div class="visualization-container">
                <h4 style="margin-bottom: 15px;">ğŸ“Š ìœ ì‚¬ë„ ë¶„ì„ ì‹œê°í™”</h4>
                <img src="data:image/png;base64,${vizResult.visualization}" alt="ìœ ì‚¬ë„ ë¶„ì„ ì‹œê°í™”">
              </div>
            `;
          } else {
            // ì‹œê°í™” ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ì •ë³´ í‘œì‹œ
            vizHTML += `
              <div style="background: #fff3cd; padding: 20px; border-radius: 6px; border: 1px solid #ffeaa7; color: #856404;">
                <div style="font-size: 16px; margin-bottom: 10px; color: #8E12D5;">âš ï¸ ì‹œê°í™” ìƒì„± ì‹¤íŒ¨</div>
                <div style="font-size: 14px; margin-bottom: 15px;">
                  ì‹œê°í™” ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.<br>
                  <strong>ì›ì¸:</strong> ${vizResult.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                </div>
            `;
            
            // ëŒ€ì²´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ
            if (vizResult.fallback_data && vizResult.fallback_data.similarity_stats) {
              const stats = vizResult.fallback_data.similarity_stats;
              vizHTML += `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #8E12D5;">
                  <div style="font-weight: 600; margin-bottom: 10px; color: #333;">ğŸ“Š ëŒ€ì²´ í†µê³„ ì •ë³´</div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <div style="text-align: center;">
                      <div style="font-size: 12px; color: #666;">í‰ê· </div>
                      <div style="font-size: 18px; font-weight: 600; color: #8E12D5;">${stats.mean.toFixed(3)}</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 12px; color: #666;">í‘œì¤€í¸ì°¨</div>
                      <div style="font-size: 18px; font-weight: 600; color: #8E12D5;">${stats.std.toFixed(3)}</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 12px; color: #666;">ìµœì†Œê°’</div>
                      <div style="font-size: 18px; font-weight: 600; color: #8E12D5;">${stats.min.toFixed(3)}</div>
                    </div>
                    <div style="text-align: center;">
                      <div style="font-size: 12px; color: #666;">ìµœëŒ€ê°’</div>
                      <div style="font-size: 18px; font-weight: 600; color: #8E12D5;">${stats.max.toFixed(3)}</div>
                    </div>
                  </div>
                </div>
              `;
            }
            
            vizHTML += `
                <div style="margin-top: 15px; font-size: 12px; color: #856404;">
                  ğŸ’¡ <strong>í•´ê²° ë°©ë²•:</strong> ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ê±°ë‚˜ matplotlib ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì¬ì„¤ì¹˜í•´ë³´ì„¸ìš”.
                </div>
              </div>
            `;
          }

          // ì°¨ì› ì¶•ì†Œ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
          if (currentAnalysisResult.dimensionality_reduction) {
            const dr = currentAnalysisResult.dimensionality_reduction;
            vizHTML += `
              <div class="stats-section">
                <h4>ğŸ“‰ ì°¨ì› ì¶•ì†Œ ê²°ê³¼</h4>
                <div class="stats-grid">
                  <div class="stat-item">
                    <h5>PCA ì„¤ëª… ë¶„ì‚° ë¹„ìœ¨</h5>
                    <div class="stat-value">${(dr.explained_variance_ratio[0] * 100).toFixed(1)}%</div>
                  </div>
                  <div class="stat-item">
                    <h5>t-SNE ì°¨ì›</h5>
                    <div class="stat-value">2D</div>
                  </div>
                </div>
              </div>
            `;
          }

          contentDiv.innerHTML = vizHTML;
        } else {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ì‹œê°í™” ìƒì„± ì‹¤íŒ¨');
        }
      } catch (error) {
        contentDiv.innerHTML = `
          <div class="error-message">
            <strong>ì‹œê°í™” ì˜¤ë¥˜:</strong> ${error.message}
          </div>
        `;
      }
    }

    // ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
    function exportAnalysisResults() {
      if (!currentAnalysisResult) {
        alert('ë¨¼ì € ìœ ì‚¬ë„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        // JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°
        const dataStr = JSON.stringify(currentAnalysisResult, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `similarity_analysis_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
        link.click();
        
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        const contentDiv = document.getElementById('analysisContent');
        contentDiv.innerHTML = `
          <div class="success-message">
            <strong>ğŸ’¾ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!</strong><br>
            íŒŒì¼ëª…: ${link.download}
          </div>
        `;
      } catch (error) {
        alert(`ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: ${error.message}`);
      }
    }
  </script>
</body>
</html>
